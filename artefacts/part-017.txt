
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 7(113) 03:12 10-SEP-75 PAGE 23-5
F3
MAC
6-SEP-64 03:11
MULTIPLE DIMENSION CODE
6125
23940
STRATEGY:
6126
23960
NUMDIM=NUMBER OF DIMENSIONS
-
6127
23980
CURTOL=0
6128
24000
INLPNMIGET A NEW INDICE
6129
24020
POP NEW MAX INTO CURMAX
6130
24040
MAKE SURE INDICE IS NOT TOO BIG
6131
24060
MUTLIPLY CURTOL BY CURMAX
6132
24080
ADD INDICE TO CURTOL
6133
24100
NUMDIM=NUMDIM-1
6134
24120
JNZ
INLPNM
6135
24140
USE CURTOL*4 (VALTYP FOR EXTENDED) AS OFFSET
6136
24160
6137 007245 001000 000043
24180
GETDEF: INX
H
;POINT PAST THE NUMBER OF DIMENSIONS
6138 007246 001000
000601
24200
LXI
B,SCODE
;CURTOL=ZERO
6139 007247 000000
000600
6140 007250 000000
007243
6141 007251 001000
000026
24220
XWD
701000,-026
1"MVI D, " AROUND THE NEXT BYTE
6142 007252' 001000
000341
24240
INLPNM: POP
H
ICH,L1= POINTER INTO VARIABLE ENTRY
6143 007253 001000
000136
24260
MOV
E,M
(D,E) =MAXIMUM FOR THE CURRENT INDICE
6144 007254 001000
000043
24280
INX
H
6145 007255 001000
000126
24300
MOV
D,M
6146 007256 001000
000043
24320
INX
H
6147
007257
001000
000343
24340
XTHL
; CH, =CURRENT INDICE
6148
24360
;POINTER INTO THE VARIABLE GOES ON THE STACK
6149 007260 001000
000365
24380
PUSH
PSW
1SAVE THE NUMBER OF DIMENSIONS
6150
007261 001000
000347
24400
COMPAR
;SEE IF THE CURRENT INDICE IS TOO BIG
6151 007262 001000
000322
24420
JNC
BSERR
;IF so "BAD SUBSCRIPT" ERROR
6152 007263 000000
007077
6153 007264 000000
007247
6154 007265 001000
000345
24440
PUSH
H
;SAVE THE CURRENT INDICE
6155 007266 001000
000315
24460
CALL
UMULT
ICURTOL=CURTOL*CURRENT MAXIMUM
6156 007267 000000
007161*
6157 007270 000000
007263
6158 007271 001000
000321
24480
POP
D
;INDICE INTO [D,E]
6159 007272' 001000
000031
24500
DAD
D
;ADD THE INDICETO CURTOL
6160 007273 001000
000361
24520
POP
PSW
;GET THE NUMBER OF DIMENSIONS IN (A)
6161 007274 001000
000075
24540
DCR
A
;SEE IF ALL THE INDICES HAVE BEEN PROCESSED
6162 007275' 001000
060104
24560
MOV
B,H
, 18, #CURTOL IN CASE WE LOOP BACK
6163 007276 001000
000115
24580
MOV
C,L
6164 007277° 001000
000302
24600
JNZ
INLPNM
PROCESS THE REST OF THE INDICES
6165 007300 000000
007252
6166 007301 000000
007267
6167
24620
IFE
LENGTH-2,<
6168 007302 001000
000072
24640
LDA
VALTYP
;SEE HOW BIG THE VALUES ARE
6169 007303 000000
001543
6170 007304 000000
007300
6171
24660
AND MULTIPLY BY THAT SIZE
6172 007305 001000
000104
24680
MOV
B,H
;SAVE THE ORIGINAL VALUE FOR MULTIPLYING
6173 007306 001000 000115
24700
MOV
C,L
1BY THREE
6174 007307 001000 060051
24720
DAD
H
;MULTIPLY BY TWO AT LEAST
6175 007310 001000 000326
24740
SUI
4
;FOR INTEGERS AND STRINGS
6176 007311 000000 000004
6177
24760
;NO MORE MULTIPLYING BY TWO
BASIC MCS 8080 GATES/ALLEN/DAVIDOFH
MACRO 47(113) 03:12 10-SEP-75 PAGE 23-6
F3
MAC
6-SEP-64 03:11
MULTIPLE DIMENSION CODE
6178 007312 001000 000332
24780
JC
SMLVAL
6179 007313 000000 007322'
6180 007314 000000 007303
6181 007315 001000 000051
24800
DAD
H
;NOW MULTIPLIED BY FOUR
6182 007316 001000 000312
24820
JZ
DONMUL
;IF SINGLE ALL DONE
6183 007317* 000000
007326
6184 007320 000000
007313
6185 007321 001000 000051
24840
DAD
H
;BY EIGHT FOR DOUBLES
6186 007322' 001000
000342
24860
SMLVAL: JPO
DONMUL
;FOR STRINGS
6187 007323 000000
007326
6188 007324 000000 0073179
6189 007325 001000 000011
24880
DAD
8
BADD IN THE ORIGINAL
6190
007326
24900
DONMUL:>
6191
24920
IFN
LENGTH-2,
<
6192
24940
DAD
H
;MULTIPLY CURTOL BY FOUR
6193
24960
DAD
H>
6194
007326' 001000 000301
24980
POP
B
;POP OFF THE ADDRESS OF WHERE THE VALUES
6195
25000
;BEGIN
6196
007327
001000
000011
25020
DAD
B
BADD IT ONTO CURTOL TO GET THE
6197
25040
;PLACE THE VALUE IS STORED
6198 007330 001000 000353
25060
XCHG
RETURN THE POINTER IN (D,E)
6199 007331 001000 000052
25080
FINNOW: LHLD
TEMP2
;REGET THE TEXT POINTER
6200 007332 000000 001605'
6201 007333 000000 007323'
6202 007334 001000 000053
25100
DCX
H
IREREAD THE TERMINATING CHARACTER
6203 007335 001000 000327
25120
CHRGET
6204
007336 001000 000311
25140
RET>
6205
6206
25180
PAGE
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 24
F3
MAC
6-SEP-64 03:11
FRE FUNCTION AND INTEGER TO FLOATING ROUTINES
6207
25200 SUBTTL FRE FUNCTION AND INTEGER TO FLOATING ROUTINES
6208
25220
IFN
LENGTH,
6209
007337 001000
000052
25240
FRE:
LHLD
STREND
;GET END OF VARIABLE AND TEXT SPACE
6210
007340 000000
001625'
6211
007341
000000
007332
6212
007342'
001000
000353
25260
XCHG
1PUT IT IN (D,E) FOR SUBTRACTION
6213
007343
001000
000041
25280
LXI
H,SCODE
;ZERO (H,L)
6214
007344
000000
000000
6215
007345 000000
007340
6216
007346
001000
000071
25300
DAD
SP
;PUT THE STACK POINTER IN (H,L)
6217
25320
IFN
STRING,
6218
25340
IFE
LENGTH-2,<
6219
007347
001000
000315
25360
CALL
GETYPE
6220
007350
000000
006307
6221
007351
000000
007344
6222
007352'
001000
000302
25370
JNZ
GIVDBL>
6223
007353
000000
007372'
6224
007354
000000
007350
6225
25380
IFN
LENGTH-2,<
6226
25400
LDA
VALTYP
IWAS THE ARGUMENT A STRING?
6227
25420
ORA
A
6228
25440
JZ
GIVDBL>
INO, GIVE FREE VARIABLE SPACE
6229
007355 001000
000315
25460
CALL
FREFAC
;FREE UP ARGUMENT AND SETUP
6230
007356 000000
010434
6231
007357 000000
007353
6232
25480
ITO GIVE FREE STRING SPACE
6233
007360° 001000
000315
25500
CALL
GARBA2
100 GARBAGE COLLECTION
6234
007361 000000
010042'
6235 007362' 000000
007356
6236 007363 001000
000052
25520
LHLD
STKTOP
,BOTTOM OF FREE AREA
6237 007364 000000
001615
6238 007365 000000
007361
6239
007366 001000
000353
25540
XCHG
6240
007367 001000
000052
25560
LHLD
FRETOP>:
;TOP OF FREE AREA
6241
007370
000000
001573
6242
007371
000000
007364
6243
25580
;
6244
25600
;
THIS ROUTINE SUBTRACTS (0,E) FROM (H,L)
.
6245
25620
;
AND FLOATS THE RESULT LEAVING IT IN FAC.
6246
25640
;
6247
25660
IFE
LENGTH-1, <
6248
25680
GIVDBL: MOV
A,L
100 THE SUBTRACTION
6249
25700
SUB
E
6250
25720
MOV
C,A
6251
25740
MOV
A,H
6252
25760
SBB
D
6253
25780
GIVACH: MOV
B,C
6254
25790
IFN
LENGTH-2,<
6255
25800
GIVABF: MOV
0,8
6256
25820
MVI
E,0
;GET ZERO IN LOW
6257
25840
IFN
STRING,
6258
25860
LXI
H, VALTYP
IFLAG VALUE TYPE AS NUMERIC
6259
25880
MOV
M,Ex
BASIC MCS 8080
GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 24-1
F3
MAC
6-SEP-64 03:11
FRE FUNCTION AND INTEGER TO FLOATING ROUTINES
6260
25900
MVI
8,144
ISETUP TO FLOAT [B,C]
6261
25920
JMP
FLOATR>
6262
26120
IFE
LENGTH-
6263
007372'
001000
000175
26140
GIVDBL:
MOV
A,L
; [H,LJH,LJ-ID,E)
6264
007373'
001000
000223
26160
SUB
E
6265 007374 001000
000157
26180
MOV
L.A
6266 007375 001000
000174
26200
MOV
A,H
6267 007376 001000
000232
26220
SBB
D
6268 007377° 001000
000021
26240
XWD
*01000,001
ISKIP THE NEXT TWO BYTES WITH "LXI D,"
6269 007400 001000
000157
26260
SNGFLT: MOV
L.A
;MAKE (A) AN UNSIGNED INTEGER
6270 007401 001000
000257
26280
XRA
A
6271 007402' 001000
000147
26300
GIVINT: MOV
H,A
6272
007403 001000
000303
26320
JMP
MAKINI>
6273
007404 000000
006471*
6274
007405 000000 007370
6275
26322
IFN
LENGTH,
6276
26324
IFN
LPTSW,<
6277
26326
LPOS:
LDA
LPTPOS
6278
26328
JMP
SNGFLT>
6279
007406 001000 000072
26330
POS:
LDA
TTYPOS
;GET TELETYPE POSITION
6280
007407 000000 000047
6281
007410 000000 007404
6282
26332
IFN
LENGTH-2,
6283
26334
SNGFLT: MOV
B,A
;RETURN FLOATING 1 BYTE
6284
26336
XRA
A
UNSIGNED FROM A
6285
26338
JMP
GIVABF>>
;GIVING 0-255
6286
6287
26360
PAGE
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 17(113) 03:12 10-SEP-75 PAGE 25
F3
MAC
6-SEP-64 03:11
SIMPLE-USER-DEFINED-FUNCTION CODE
6288
26380 SUBTTL SIMPLE-USER-DEFINED-FUNCTION CODE
6289
26390
IFN FUNCTS,
6290
26400
;
6291
26420
; NOTE ONLY SINGLE ARGUMENTS ARE ALLOWED TO FUNCTIONS
6292
26440
; AND FUNCTIONS MUST BE OF THE SINGLE LINE FORM:
6293
26460
; DEF A(X)=X"2+X-2
6294
26480
; NO STRINGS CAN BE INVOLVED WITH THESE FUNCTIONS
6295
6296
26520
; IDEA: CREATE A FUNNY SIMPLE VARIABLE ENTRY
6297
26540
WHOSE FIRST CHARACTER (SECOND WORD IN MEMORY)
6298
26560
HAS THE 200 BIT SET.
6299
26580
THE VALUE WILL BE:
6300
26600
6301
26620
A TXTPTR TO THE FORMULA
6302
26640
A PTR TO THE ARGUMENT VARIABLE
6303
26660
6304
26680
FUNCTION NAMES CAN BE LIKE "FNA4"
6305
26700
6306
6307
007411 001000
000315
26780
DEF
CALL
GETFNM
;GET A POINTER TO THE
6308
007412
000000
007550
6309
007413
000000
007407
6310
26800
;FUNCTION VARAIBLE
6311
007414
001000
000601
26820
LXI
B,DATA
EVENTUALLY RETURN TO "DATA"
6312
007415
000000
004072'
6313
007416
000000
007412
6314 007417 001000
000305
26840
PUSH
B
;AND SKIP THE FORMULA
6315 007420° 001000
000325
26860
PUSH
D
;SAVE A POINTER TO IT
6316 007421 001000
000315
26880
CALL
ERROIR
;DEF IS "ILLEGAL DIRECT"
6317
007422' 000000
007532
6318 007423 000000
007415
6319
007424 001000
000317
26900
SYNCHK
'("
MUST HAVE " ("
6320
007425 000000
000050
6321
26920
;SINCE WE STORE A TEXT POINTER
6322
007426 001000
000315
26940
CALL
PIRGET
;GET POINTER TO ARGUMENT
6323
007427 000000
006505'
6324
007430
000000
007422'
6325
26960
IFN
LENGTH=2,
6326
26980
IFN
STRING, <CALL
CHKNUM>>ISTRINGS ILLEGAL
6327
007431 001000
000317
27000
SYNCHK ")"
MUST CLOSE IT WITH ")"
6328
007432' 000000
000051
6329
007433' 001000
000317
27020
SYNCHK
EQULTK
;MUST HAVE EQUAL
6330 007434 000000
000260
6331 007435 001000
000104
27040
MOV
B,H
6332
007436 001000
000115
27060
MOV
C,L
6333
007437 001000 000343
27080
XTHL
;PUT THE TXTPTR ON THE STACK
6334
27100
: [H,L]=PTR TO FUNCTION VARIABLE
6335
27120
(8,C)=TXTPTR
6336 007440 001000 000303
27140
JMP
DEFFIN
;PUT DOWN THE TEXT-POINTER
6337
007441 000000 007521
6338 007442 000000 007427
6339
27160
AND ARGUMENT POINTER IN
6340
27180
;MEMORY, RESTORE THE TXTPTR
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 25-1
F3
MAC
6-SEP-64 03:11
SIMPLE-USER-DEFINED-FUNCTION CODE
6341
27200
AND GO TO "DATA" SKIPPING THE
6342
27220
;REST OF THE FORMULA
6343
6344
007443 001000
000315
27260
FNDOER: CALL
GETFNM
;GET A POINTER TO
6345
007444 000000 007550
6346
007445'
000000
007441
6347
27280
;THE FUNCTON DEFINITION IN (D,E)
6348
007446 001000
000325
27300
PUSH
D
;SAVE THE POINTER
6349
007447 001000
000315
27320
CALL
PARCHK
EVALUATE THE VALUE TO BE PASSED
6350 007450 000000 006136
6351
007451 000000
007444
6352
27340
IFN
LENGTH-21
6353
27360
IFN
STRING, <CALL
CHKNUM>> ;ARG CANNOT BE STRING
6354
007452' 001000 000343
27380
XTHL
, (H,L =POINTER TO FUNCTION DEF
6355
27400
;TEXT POINTER GOES ON THE STACK
6356
007453
001000
000367
27420
PUSHM
;PUSH THE POINTER AT THE FORMULA
6357
27440
;ONTO THE STACK
6358
007454
001000
000321
27460
POP
D
[D,E] #PTR TO FORMULA
6359 007455' 001000 000367
27480
PUSHM
IPUT A POINTER TO THE
6360
27500
;ARGUMENT ON THE STACK
6361 007456 001000 000341
27520
POP
H
; [H,LI =POINTER TO ARG
6362 007457 001000
060367
27540
PUSHEM
;SAVE ARGS OLD VALUE ON THE STACK
6363 007460 001000
000367
6364 007461 001000
000053
27560
DCX
H
6365 007462' 001000
000053
27580
DCX
H
6366
007463 001000
000053
27600
DCX
H
;POINT TO FRONT OF ARG AGAIN
6367 007464 001000
000053
27620
DCX
H
6368
007465 001000
000345
27640
PUSH
H
;SAVE IT
6369
007466 001000
000347
27660
COMPAR
;SHOULDN'T BE EQUAL UNLESS
6370
27680
JUNCTION WAS NEVER DEFINED
6371 007467 001000
000325
27700
PUSH
D
;SAVE FORMULA TEXT POINTER
6372 007470* 001000
000036
27720
MVI
E, ERRUF
;NOW ID,E FREE so CHECK IF (ZERO) SET
6373 007471 000000
000022
6374 007472' 001000
000312
27740
JZ
ERROR
6375 007473 000000
062102'
6376 007474 000000
007450°
6377 007475 001000
000315
27760
CALL
MOVMF
;PUT CURRENT FAC INTO OUR ARG VARIABLE
6378
007476 000000
005264*
6379 007477° 000000
007473
6380
27780
TOUT OF FAC INTO [H,L] LOCATION
6381
007500
001000
000341
27800
POP
H
:POP OFF FORMULA TXTPTR
6382
27810
IFN
LENGTH-2,<
6383
27820
CALL
FRMNUM>
;EVALUATE IT AND MUST SURE ITS NUMERIC
6384
27822
IFE
LENGTH-2,
6385
007501
001000
000315
27824
CALL
FRMEVL
6386
007502
000000
005336
6387
007503
000000
007476
6388 007504 001000 000345
27826
PUSH
H
6389
007505° 001000
000315
27828
CALL
FRCSNG
6390
007506 000000
006267*
6391
007507 000000
007502
6392
007510 001000 000341
27830
POP
H>
6393
007511 001000 000053
27840
DCX
H
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 25-2
F3
MAC
6-SEP-64 03:11
SIMPLE-USER-DEFINED-FUNCTION CODE
6394 007512 001000 000327
27860
CHRGET
;SEE IF TERMINATED
6395
007513 001000 000302
27880
JNZ
SNERR
;IF NOT SYNTAX ERROR
6396
007514 000000 002072
6397
007515 000000 007506
6398
27900
;TO BE NICE SHOULD HAVE NEW CURLIN
6399
27920
;BUT VERY MESSY
6400
007516' 001000
000341
27940
POP
H
IPOP OFF POINTER AT ARG VARIABLE
6401
007517 001000
000321
27960
POP
D
6402
007520 001000
000301
27980
POP
8>
1POP OFF OLD VALUE
6403
28000
IFN
MULDIMISTRINGIFUNCTS,
6404
007521 001000
000161
28020
DEFFIN: MOV
M,C
6405
007522' 001000
000043
28040
INX
H
;STORE THE OLD VALUE
6406 007523' 001000
000160
28060
MOV
M,B
6407
007524 001000
000043
28080
PUTDEI: INX
H
6408
007525* 001000
000163
28100
MOV
M,E
6409
007526 001000
000043
28120
INX
H
6410
007527 001000
000162
28140
MOV
M,D
6411
007530 001000
000341
28160
POP
H
;POP OFF OLD TXTPTR
6412
007531 001000
000311
28180
RET>
;VALUE IS IN FAC -- ALL DONE
6413
28200
IFN
FUNCTS, <
6414
28220
6415
28240
SUBROUTINE TO SEE IF WE ARE IN DIRECT MODE AND
6416
28260
;
COMPLAIN IF so
6417
28280
6418
007532
001000
000345
28300
ERRDIR: PUSH
H
;SAVE THEIR [H,L]
6419
007533'
001000
000052
28320
LHLD
CURLIN
ISEE WHAT THE CURRENT LINE IS
6420
007534
000000
001607
6421
007535
000000
007514
6422
007536 001000
000043
28340
INX
H
;DIRECT IS 65,535 so NOW 0
6423
007537 001000
000174
28360
MOV
A,H
6424 007540° 001000
000265
28380
ORA
L
HIS IT ZERO NOW?
6425
007541 001000
000341
28400
POP
H
6426
007542 001000
000300
28420
RNZ
RETURN IF NOT
6427
007543 001000
000036
28440
MVI
E,ERRID
;"ILLEGAL DIRECT" ERROR
6428
007544 000000
000014
6429
007545 001000
000303
28460
JMP
ERROR
6430
007546 000000
002102
6431
007547
000000
007534
6432
28480
6433
28500
SUBROUTINE TO GET A POINTER TO A FUNCTION NAME
6434
28520
6435
007550
001000
000317
28540
GETENM: SYNCHK FNTK
;MUST START WITH "FN"
6436 007551 000000
000243
6437
007552' 001000
000076
28560
MVI
A,128
;DONT ALLOW AN ARRAY
6438
007553 000000
000200
6439
007554 001000
000062
28580
STA
SUBFLG
;DON'T RECOGNIZE THE (" AS
6440
007555' 000000
001601
6441
007556 000000
007546
6442
28600
;THE START OF AN ARRAY REFEREENCE
6443
007557
001000
000266
28620
ORA
M
;PUT FUNCTION BIT ON
6444
007560
001000
000107
28640
MOV
B,A
;GET FIRST CHARACTER INTO [B]
6445
28660
IFN
LENGTH-2,
6446
28680
IFN
STRING, <CALL
PTRGT2 ;REALLY GET THE POINTER
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 25-3
F3
MAC
6-SEP-64 03:11
SIMPLE-USER-DEFINED-FUNCTION: CODE
6447
28700
JMP
CHKNUM>>
;MAKE SURE ITS NOT A STRING NAME
6448
007561 001000 000303
28720
IFE
STRING&<LENGTH-2>, <JMP PTRGT2>>
6449
007562' 000000 006512'
6450
007563 000000 007555'
6451
28740
PAGE