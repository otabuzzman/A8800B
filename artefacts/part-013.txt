
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO (113) 03:12 10-SEP-75 PAGE 21
F3
MAC
6-SEP-64 03:11
FORMULA EVALUATION CODE
4470
00020 SUBTTL FORMULA EVALUATION CODE
4471
4472
00060
IFN
LENGTH-2,
4473
00080
IFN
STRING,<
4474
00100
4475
00120
THESE ROUTINES CHECK FOR A CERTAIN VALTYP
4476
90140
;
[A] IS NOT PRESERVED
4477
00160
4478
00180
FRMNUM: CALL
FRMEVL
EVALUATE A FORMULA
4479
00200
CHKNUM: XWD
*01000, 0366
ITURN CARRY OFF WITH ORI
4480
00220
CHKSTR: STC
;SET CARRY
4481
00240
CHKVAL: LDA
VALTYP
10 MEANS NUMERIC 1 MEANS STRING
4482
00260
ADC
A
RESULT SHOULD BE 0 OR 3
4483
00280
;BAD RESULTS ARE 2 AND 1
4484
00300
RPE
;RETURN IF CORRECT RESULT
4485
00320
TMERR:
MVI
E,ERRTM
1"TYPE MISMATCH ERROR"
4486
00340
JMP
ERROR
4487
00360
4488
00380
THE FORMULA EVALUATOR STARTS WITH
4489
00400
(H,L) POINTING TO THE FIRST CHARACTER OF THE FORMULA,
4490
00420
AT THE END [H,L] POINTS TO THE TERMINATOR.
4491
00440
THE RESULT IS LEFT IN THE FAC.
4492
00460
4493
00480
THE FORMULA EVALUATOR USES THE OPERATOR TABLE (OPTAB)
4494
00500
TO DETERMINE PRECEDENCE AND DISPATCH ADDRESSES FOR
4495
00520
EACH OPERATOR.
4496
00540
A TEMPORARY RESULT ON THE STACK HAS THE FOLLOWING FORMAT
4497
00560
4498
00580
THE
ADDRESS OF RETAOP -- THE PLACE TO RETURN ON COMPLETION
4499
00600
OF OPERATOR APPLICATION
4500
00620
4501
00640
THE FLOATING POINT TEMPORARY RESULT
4502
00660
4503
00680
THE ADDRESS OF THE OPERATOR ROUNTINE
4504
00700
4505
00720
THE PRECEDENCE OF THE OPERATOR
4506
00740
4507
00760
,
TOTAL 10 BYTES
4508
00780
;
4509
00800
IFE
STRING, <FRMNUM:>
4510 005336 001000
000053
00820
FRMEVL: DCX
H
18ACK UP CHARACTER POINTER
4511
005337 001000
000026
00840
FRMCHK: MVI
0,0
;INITIAL DUMMY PRECEDENCE IS 0
4512 005340 000000
000000
4513 005341 001000
000325
00860
LPOPER: PUSH
D
;SAVE PRECEDENCE
4514 005342' 001000
000315
00880
CALL
GETSTK
;MAKE SURE THERE IS ROOM FOR RECURSIVE CALLS
4515 005343 000000
002024
4516 005344 000000
005334
4517 005345 000000
000001
00900
1
4518 005346 001000
000315
00920
CALL
EVAL
;EVALUATE SOMETHING
4519 005347 000000
006061
4520
005350 000000
005343
4521
005351 001000
000042
00940
SHLD
TEMP2
ISAVE TEXT POINTER
4522
005352' 000000
001605
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 21-1
F3
MAC
6-SEP-64 03:11
FORMULA EVALUATION CODE
4523 005353 000000 005347
4524 005354 001000 000052
00960 RETAOP: LHLD
TEMP2
IRESTORE TEXT PTR
4525 005355' 000000 001605
4526
005356 000000 005352'
4527
005357 001000 000301
00980
TSTOP:
POP
B
;POP OFF THE PRECEDENCE OF OLDOP
4528
01000
IFN
LENGTH-2,4
4529
01020
IFN
STRING,<
4530
01040
MOV
A,B
FLOOK AT PRECEDENCE
4531
01060
CPI
120
IIF ITS SOME ARITHMETIC
4532
01080
;TYPE THING WE SHOULDN'T
4533
01100
ISEE STRINGS
4534
01120
CNC
CHKNUM>>
;TYPE MISMATCH ERROR IF NOT NUMERIC
4535
005360 001000 060176
01140
NOTSTV: MOV
A,M
;GET NEXT CHARACTER
4536
01160
IFN
LENGTH,
4537
005361
001000
000026
01180
MVI
0,0
ASSUME NO RELATION OPS
4538
005362
000000
000000
4539
005363
001000
000326
01200
LOPREL: SUI
GREATK
HIS THIS ONE RELATION?
4540
005364 000000
000257
4541
005365 001000
000332
01220
JC
ENDREL
IRELATIONS ALL THROUGH
4542
005366 000000
005415'
4543
005367 000000
005355'
4544
000003
01240 INMREL==LESSTK-GREATK+1
4545
005370 001000
000376
01260
CPI
NMREL
;IS IT REALLY RELATIONAL?
4546 005371 000000
000003
4547 005372 001000
000322
01280
JNC
ENDREL
INO JUST BIG
4548 005373 000000
005415
4549
005374 000000
005366
4550
005375 001000
000376
01300
CPI
1
;SET UP BITS BY MAPPING
4551
005376
000000
000001
4552 005377 001000
000027
01320
RAL
10 TO 1 1 TO 2 AND 2 TO 4
4553
005400 001000
000252
01340
XRA
D
;BRING IN THE OLD BITS
4554 005401 001000
000272
01360
CMP
D
;MAKE SURE RESULT IS BIGGER
4555
005402*
001000
000127
01380
MOV
D,A
;SAVE THE MASK
4556 005403 001000
000332
01400
JC
SNERR
IDON'T ALLOW TWO OF THE SAME
4557
005404 000000
002072
4558
005405 000000
005373
4559
005406 001000
000042
01420
SHLD
TEMP3
;SAVE CHARACTER POINTER
4560
005407 000000
001575'
4561
005410
000000
005404
4562
005411 001000
000327
01440
CHRGET
;GET THE NEXT CANDIDATE
4563
005412
001000
000303
01460
JMP
LOPREL
4564
005413
000000
005363
4565
005414
000000
005407
4566
005415
001000
000172
01480
ENDREL: MOV
A,D
;GET THE MASK
4567
005416
001000
000267
01500
ORA
A
;WERE THERE ANY?
4568
005417
001000
000302
01520
JNZ
FINREL
IF so, HANDLE AS SPECIAL OP
4569
005420
000000
005605
4570 005421 000000
005413
4571 005422' 001000
060176
01540
MOV
A,M
;GET THE CHARACTER AGAIN
4572 005423 001000
000642
01560
SHLD
TEMP3>
;SAVE UPDATED CHARACTER POINTER
4573
005424
000000
001575'
4574
005425'
000000
005420
4575 005426 001000 000326
01580
SUI
PLUSTK
IAN OPERATOR?
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47 (113) 03:12 10-SEP-75 PAGE 21-2
F3
MAC
6-SEP-64 03:11
FORMULA EVALUATION CODE
4576 005427 000000 000250
4577 005430 001000 000330
01600
RC
RETURN IF NOT
4578
01620
ITHIS CAN RESULT IN OPERATOR
4579
01640
;APPLICATION OR ACTUAL RETURN
4580 005431' 001000 000376
01660
CPI
LSTOPK
;HIGHER THAN THE LAST OP?
4581 0054321 000000 000007
4582 005433 001000 000320
01680
RNC
4583
005434 001000
060137
01700
MOV
E,A
MUST MUTIPLY BY 3 SINCE
4584
01720
10PTAB ENTRIES ARE 3 LONG
4585
01740
IFN
STRING,
4586 005435 001000 000672
01760
LDA
VALTYP
;SEE IF LEFT PART IS STRING
4587 005436 000000 001543
4588 005437 000000 005424
4589
01780
IFE
LENGTH-2,
4590
005440 001000 000376
01800
CPI
3>
;SEE IF ITS A STRING
4591
005441 000000 000003
4592
01820
IFN
LENGTH-2,<
4593
01840
DCR
A>
4594
005442' 001000 000263
01860
ORA
E
1SET CONDITION CODES
4595
01880
IFN
LENGTH-2,
4596
01900
MOV
A,E>
IREFETCH OP-VALUE
4597
005443 001000 060312
01920
JZ
CAT>
;MUST BE CAT
4598
005444 000000 010320
4599
005445' 000000 005436
4600
01940
IFN
LENGTH-2,<
4601
01960
RLC
IA# ORIGINAL A*2
4602
01980
ADD
E
;ADD IN ORIGINAL A
4603
02000
MOV
E,A>
;CREATE TWO BYTE VALUE
4604
02020
IFE
LENGTH,
4605
02040
MVI
0,0>
;HIGH ORDER #0
4606
005446 001000
000041
02060
LXI
H,OPTAB
;CREATE INDEX INTO OPTAB
4607 005447 000000 000163
4608 005450 000000
005444
4609 005451 001000 000031
02080
DAD
D
1 ADD IN CALCULATED OFFSET
4610 005452' 001000
000170
02100
MOV
A,B
(A) GETS OLD PRECEDENCE
4611
005453' 001000
000126
02120
MOV
D.M
REMEMBER NEW PRECEDENCE
4612
005454° 001000
000272
02140
CMP
D
;OLD-NEW
4613
005455' 001000 000320
02160
RNC
MUST APPLY OLD OP
4614
02180
IIF HAS GREATER OR = PRECEDENCE
4615
02200
IFN
LENGTH-2,
4616
02220
INX
H
NOW POINTING AT ROUTINE ADDRESS
4617
02240
IFN
STRING,<CALL
CHKNUM>
ICAN'T BE STRING HERE
4618
02260
1SINCE THE ONLY STRING OPERATOR
4619
02280
;IS PLUS AND RELATIONALS
4620
02300
IDON'T COME THROUGH HERE
4621
02320
DOPREC: PUSH
B
SAVE OLD PRECEDENCE
4622
02340
LXI
,RETAOP
1OPERATOR RETURN ADDRESS
4623
02360
PUSH
8
;FIRST PART OF "TEMP" ENTRY
4624
02380
IFN
LENGTH,
4625
02400
MOV
B,E>
;SAVE SECOND BYTE OF PRECEDENCE
4626
02420
;SINCE FOR RELATIONAL OPERATORS
4627
02440
,IT GIVES THE VALUE TYPE OF
4628
02460
,THE LEFT SIDE AND IT TELLS
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47 7(113) 03:12 10-SEP-75 PAGE 21-3
F3
MAC
6-SEP-64 03:11
FORMULA EVALUATION CODE
4629
02480
TWHICH RELATIONAL-OPERATOR
4630
02500
IIT WAS
4631
02520
MOV
C,D
4632
02540
CALL
PUSHF
4633
02560
IFN
LENGTH,
4634
02580
MOV
E,8>
IGET SECOND BYTE OF PRECEDENCE AGAIN
4635
02600
MOV
D,C
[D] GETS PRECEDENCE
4636
02620
PUSHM
1PUT ROUTINE ADDRESS ON THE STACK
4637
02640
IFN
LENGTH,
4638
02660
LHLD
TEMP3>
4639
02680
IFE
LENGTH,
4640
02700
LHLD
TEMP2>
IIF WE DONT HAVE "LENGTH"
4641
02720
ION OPERATORS CAN ONLY
4642
02740
IBE ONE CHARACTER so TO "REREAD"
4643
02760
IAN OPERATOR THAT WE LOOKED
4644
02780
BAT BEFORE AND DECIDED NOT TO
4645
02800
PAPPLY WE JUST "DCX H"
4646
02820
I IF LENGTH IS ON WE HAVE TO
4647
02840
IREMEMBER THE TEXT POINTER BEFORE
4648
02860
,THE OPERATOR AND AFTER so WE CAN
4649
02880
;EITHER RESCAN THE OPERATOR
4650
02900
ILATER IF IT DOESN'T GET APPLIED
4651
02920
10R GO BEYOND IT WHEN IT DOES
4652
02940
JMP
LPOPER>
1PUT ON PRECEDENCE AND LOOK AT A
4653
02960
INEW OPERATOR
4654
4655
03000
IFE
LENGTH-2, <
4656
005456 001000
000305
03020
PUSH
8
;SAVE THE OLD PRECEDENCE
4657
005457 001000
000001
03040
LXI
,RETAOP
1PUT ON THE ADDRESS OF THE
4658
005460° 000000
005354
4659
005461 000000
005447
4660
03060
PUSH
B
PLACE TO RETURN TO AFTER OPERATOR APPLICATION
4661
005462 001000
000305
4662
005463 001000
000172
03080
MOV
A,D
ISEE IF THE OPERATOR IS EXPONENTIATION
4663 005464 001000
000376
03100
CPI
127
;WHICH HAS PRECEDENCE 127
4664
005465' 000000
000177
4665
03120
JZ
EXPSTK
IF so, "FRCSNG" AND MAKE A SPECIAL STACK ENTRY
4666
005466 001000
000312
4667 005467 000000
005553
4668
005470 000000
005460°
4669 005471 001000
000376
03140
CPI
81
ISEE IF THE OPERATOR IS "AND" OR "OR"
4670 005472' 000000
000121
4671
005473 001000
000332
03160
JC
ANDORD
AND IF so "FRCINT" AND
4672
005474 000000
005571
4673
005475' 000000
005467
4674
03162
;MAKE A SPECIAL STACK ENTRY
4675
03200
4676
03220
;
THIS CODE PUSHES THE CURRENT VALUE IN THE FAC
4677
03240
, ONTO THE STACK, EXCEPT IN THE CASE OF STRINGS IN WHICH IT CALLS
4678
03260
; TYPE MISMATCH ERROR. [D] AND (E) ARE PRESERVED.
4679
03280
;
4680
005476 001000 000072
03300
NUMREL: LDA
VALTYP
;GET THE VALUE TYPE
4681
005477° 000000 001543
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 21-4
F3
MAC
6-SEP-64 03:11
FORMULA EVALUATION CODE
4682 005500 000000 005474
4683 005501 001000 000376
03302
CPI
3
, AND SET THE CONDITION CODES BASED ON IT
4684 005502' 000000 000003
4685 005503 001000 000312
03320
JZ
TMERR
BLOW UP ON STRINGS
4686 005504 000000
000000*
4687 0055051 000000
005477
4688 005506 001000
060041
03340
LXI
H,FACLO
;GET POINTER TO LO IN FAC
4689 005507 000000
001637
4690 005510 000000
005504
4691 005511 001000
000116
03342
MOV
C,M
4692 005512' 001000
000043
03344
INX
H
4693 005513 001000
000106
03346
MOV
B,M
4694 005514 001000
000043
03348
INX
H
4695 005515 001000
060305
03360
PUSH
8
;PUSH FACLO+0,1 ON THE STACK
4696 005516 001000
000372
03380
JM
VPUSHD
TALL DONE IF THE DATA WAS AN INTEGER
4697 005517 000000
005536
4698 005520 000000
005507
4699 005521 001000
060116
03382
MOV
C,M
4700 005522' 001000
000043
03384
INX
H
4701 005523 001000
000106
03386
MOV
B,M
4702 005524 001000
000043
03388
INX
H
4703 005525' 001000
000305
03400
PUSH
B
PUSH FAC-1, ON THE STACK
4704 005526 001000
000342
03420
JPO
VPUSHD
PALL DONE IF WE HAD A SNG
4705 005527 000000
005536
4706 005530 000000
005517
4707 005531 001000
000041
03440
LXI
H,DFACLO
WE HAVE A DOUBLE PRECISON NUMBER
4708 005532' 000000
001633
4709 005533 000000
005527
4710 005534 001060
000367
03460
PUSHM
;PUSH ITS 4 LO BYTES ON THE STACK
4711 005535 001000
000367
03480
PUSHM
4712 005536 001000
000113
03520
VPUSHD: MOV
C,E
, (C) =OPERATOR NUMBER
4713 005537 001000
000107
03560
MOV
B,A
BJ=TYPE OF VALUE ON THE STACK
4714 005540 001000
000305
03580
PUSH
8
SAVE THESE THINGS FOR APPLOP
4715 005541 001000
000001
03600
LXI
8, ,APPLOP
GENERAL OPERATOR APPLICATION
4716 005542' 000000
005642
4717 005543 000000
005532'
4718
03620
IROUTINE -- DOES TYPE CONVERSIONS
4719 005544 001000
000305
03640
FINTMP: PUSH
8
;SAVE PLACE TO GO
4720 005545' 001000
000052
03660
LHLD
TEMP3
;REGET THE TEXT POINTER
4721 005546 000000
001575'
4722 005547 000000 005542'
4723 005550 001000 000303
03680
JMP
LPOPER
IPUSH ON THE PRECEDENCE AND READ MORE
4724
005551
000000
005341
4725
005552'
000000
005546
4726
03700
IFORMULA
4727
03720
4728
03740
FOR EXPONENTIATION WE WANT TO FORCE THE CURRENT VALUE IN THE FAC
4729
03760
TO BE SINGLE PRECISION. WHEN APPLICATION TIME COMES WE FORCE
4730
03780
THE RIGHT HAND OPERAND TO SINGLE PRECISION AS WELL
4731
03800
4732
005553' 001000 000315
03820
EXPSTK: CALL
FRCSNG
;COERCE LEFT HAND OPERAND
4733 005554 000000 003256*
4734 005555' 000000 005551*
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 21-5
F3
MAC
6-SEP-64 03:11
FORMULA EVALUATION CODE
4735 005556 001000 000315
03840
CALL
PUSHF
;PUT IT ON THE STACK
4736 005557 000000 000000*
4737 005560 000000 005554
4738 005561 001000 000001
03860
LXI
B,FPWRQ##
PLACE TO COERCE RIGHT HAND
4739 005562 000000 000000*
4740 005563 000000 005557
4741
03880
1OPERAND AND DO EXPONENTIATION
4742 005564 001000 000026
03900
MVI
0,127
RESTORE THE PRECEDENCE
4743 005565 000000 000177
4744 005566 001000 000303
03920
JMP
FINTMP
FINISH ENTRY AND EVALUATE MORE FORMULA
4745 005567 000000 005544
4746 005570 000000 005562
4747
03940
4748
03960
FOR "AND" AND "OR" WE WANT TO FORCE THE CURRENT VALUE IN THE
4749
03980
FAC TO BE AN INTEGER, AND AT APPLICATION TIME FORCE THE RIGHT
4750
04000
HAND OPERAND TO BE AN INTEGER
4751
04020
;
4752
0055719 001000
000325
04040
ANDORD: PUSH
D
ISAVE THE PRECEDENCE (70 OR 80)
4753 005572' 001000
000315
04060
CALL
FRCINT
4754
005573'
000000
003630*
4755 005574 000000
005567
4756 005575 001000
000321
04080
POP
D
[D] PRECEDENCE
4757 005576 001000 080345
04100
PUSH
H
;PUSH THE LEFT HAND OPERAND
4758 005577 001000
000001
04120
LXI
B,DANDOR
""AND" AND "OR" DOER
4759 005600 000000
006437
4760 005601 000000 005573
4761 005602 001000 000303
04140
JMP
FINTMP
IPUSH ON THIS ADDRESS, PRECEDENCE
4762 005603 000000 005544
4763 005604 000000 005600
4764
04160
AND CONTINUE EVALUATION
4765
04180
4766
04200
HERE TO BUILD AN ENTRY FOR A RELATIONAL OPERATOR
4767
04220
STRINGS ARE TREATED SPECIALLY. NUMERIC COMPARES ARE DIFFERENT
4768
04240
FROM MOST OPERATOR ENTRIES ONLY IN THE FACT THAT AT THE
4769
04260
BOTTOM INSTEAD OF HAVING RETAOP, DOCMP AND THE RELATIONAL
4770
04280
BITS ARE STORED. STRINGS HAVE STRCMP,T POINTER AT THE STRING DESCRIPTOR,
4771
04300
00CMP AND THE RELATIONAL BITS.
4772
04320
;
4773 005605 001000 000170
04340
FINREL: MOV
A,8
(A) #OLD PRECEDENCE
4774 005606 001000 000376
04360
CPI
100
IRELATIONALS HAVE PRECEDENCE 100
4775 005607 000000 000144
4776 005610 001000 000320
04380
RNC
IAPPLY EARLIER OPERATOR IF IT HAS
4777
04400
;HIGHER PRECEDENCE
4778 005611 001000 000305
04420
PUSH
B
ISAVE THE OLD PRECEDENCE
4779 005612 001000 000325
04440
PUSH
D
;SAVE DJ=RELATIONAL BITS
4780 005613 001000 000021
04460
LXI
D,SCODE+25604
[D] =PRECEDENCE#100
4781 005614 000000 062004
4782 005615 000000 005603
4783
04480
, (E) =DISPATCH OFFSET FOR
4784
04500
;COMPARES IN APPLOP=4
4785
04520
;IN CASE THIS IS A NUMERIC COMPARE
4786
005616 001000 000041
04540
LXI
H,DOCMP
BROUTINE TO TAKE COMPARE ROUTINE RESULT
4787
005617 000000 006375
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO (113) 03:12 10-SEP-75 PAGE 21-6
F3
MAC
6-SEP-64 03:11
FORMULA EVALUATION CODE
4788
005620
000000
005614
4789
04560
AND RELATIONAL BITS AND RETURN THE ANSWER
4790
005621
001000
000345
04580
PUSH
H
IDOES A JMP TO RETAOP WHEN DONE
4791
005622'
001000
000315
04600
CALL
GETYPE
;SEE IF WE HAVE A NUMERIC COMPARE
4792
005623
000000
006307
4793 005624 000000 005617
4794
005625'
001000
000302
04620
JNZ
NUMREL
IYES, BUILD AN APPLOP ENTRY
4795
005626 000000
005476
4796
005627'
000000
005623
4797 005630 001000
000052
04640
LHLD
FACLO
;GET THE POINTER AT THE STRING DESCRIPTOR
4798 005631 000000
001637
4799 005632' 000000
005626
4800 005633 001000
000345
04660
PUSH
H
ISAVE IT FOR STRCMP
4801 005634 001000
000001
04680
LXI
B,STRCMP
;STRING COMPARE ROUTINE
4802 005635 000000
006320
4803
005636 000000
005631
4804 005637 001000
000303
04700
JMP
FINTMP
1PUSH THE ADDRESS, REGET THE TEXT POINTER
4805
005646 000000 005544
4806
005641 000000 005635
4807
04720
;SAVE THE PRECEDENCE AND SCAN
4808
04722
;MORE OF THE FORMULA
4809
04740
4810
04760
APPLOP IS RETURNED TO WHEN IT IS TIME TO APPLY AN ARITHMETIC
4811
04762
OR NUMERIC COMPARISON OPERATION,
4812
04764
THE STACK HAS A DOUBLE BYTE ENTRY WITH THE OPERATOR
4813
04766
NUMBER AND THE VALTYP OF THE VALUE ON THE STACK.
4814
04768
APPLOP DECIDES WHAT VALUE LEVEL THE OPERATION
4815
04770
WILL OCCUR AT, AND CONVERTS THE ARGUMENTS, APPLOP
4816
04772
USES DIFFERENT CALLING CONVENTIONS FOR EACH VALUE TYPE.
4817
04776
INTEGERS: LEFT IN (D,E) RIGHT IN [H,L]
4818
04778
SINGLES: LEFT IN [B,C,D,E] RIGHT IN THE FAC
4819
04780
DOUBLES: LEFT IN FAC RIGHT IN ARG
4820
04798
4821
005642 001000 000301
04800
APPLOP: POP
8
, [B] #STACK OPERAND VALUE TYPE
4822
04820
CJ#OPERATOR OFFSET
4823
005643
001000
000171
04840
MOV
A,C
;SAVE IN MEMORY SINCE THE STACK WILL BE BUSY
4824 005644 001000
000062
04860
STA
OPRTYP
;A RAM LOCATION
4825
005645 000000
001544
4826 005646 000000
005640
4827 005647 001000
000170
04880
MOV
A,B
CHECK FOR DOUBLE
4828 005650 001000
000376
04900
CPI
8
PRECISION ENTRY ON THE STACK
4829 005651 000000
000010
4830 005652' 001000
000312
04920
JZ
STKDBL
;FORCE FAC TO DOUBLE
4831 005653 000000
005725'
4832 005654 000000
005645
4833 005655' 001000
000072
04940
LDA
VALTYP
ISEE IF THE FAC IS DOUBLE PRECISION
4834 005656 000000
001543
4835 005657 000000
005653
4836 005660 001000
000376
04960
CPI
8
AND IF so, CONVERT THE STACK OPERAND
4837 005661 000000
000010
4838 005662' 001000 000312
04980
JZ
FACOBL
ITO DOUBLE PRECISION
4839 005663 000000 005775
4840 005664 000000 005656
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 21-7
F3
MAC
6-SEP-64 03:11
FORMULA EVALUATION CODE
4841 005665 001000 000127
05000
MOV
D,A
;SAVE THE VALUE TYPE OF THE FAC
4842 005666° 001000 000170
05020
MOV
A,B
;SEE IF THE STACK ENTRY IS SINGLE
4843 005667 001000 000376
05040
CPI
4
;PRECISION AND IF so, CONVERT
4844 005670 000000
000004
4845 005671 001000
000312
05060
JZ
STKSNG
;THE FAC TO SINGLE PRECISION
4846 005672' 000000
006021
4847 005673 000000
005663
4848 005674 001000
000172
05080
MOV
A,D
ISEE IF THE FAC IS SINGLE PRECISION
4849 005675' 001000
000376
05100
CPI
3
AND IF so CONVERT THE STACK TO SINGLE
4850 005676 000000
000003
4851 005677 001000
000322
05120
JNC
FACSNG
1PRECISION
4852 005700 000000
006034
4853 005701 000000
005672
4854
05140
;NOTE: THE STACK MUST BE INTEGER AT THIS POINT
4855 005702 001000
000312
05160
JZ
TMERR
IBLOW UP ON RIGHT HAND STRING OPERAND
4856 005703 000000
005504*
4857 005704 000000
005700
4858 005705 001000
000041
05180
LXI
H, INTDSP
,INTEGER INTEGER CASE
4859 005706 000000
000716
4860 005707 000000
005703
4861 005710 001000
000006
05200
MVI
B,0
1SPECIAL DISPATCH FOR SPEED
4862 005711 000000
000000
4863 005712 001000
000011
05220
DAD
8
, [H,L] POINTS TO THE ADDRESS TO GO TO
4864 005713 001000
000011
05240
DAD
B
4865 005714 001000
000116
05260
MOV
C,M
; =ROUTINE ADDRESS
4866 005715 001000
000643
05280
INX
H
4867 005716 001000
000106
05300
MOV
B,M
4868 005717 001000
000321
05320
POP
D
; (D,E)=LEFT HAND OPERAND
4869 005720 001000
000052
05340
LHLD
FACLO
, [H,L]=RIGHT HAND OPERAND
4870 005721 000000
001637
4871 005722' 000000 005706
4872 005723' 001000 000305
05360
PUSH
B
:DISPATCH
4873 005724 001000 000311
05380
RET
4874
05400
4875
05420
THE STACK OPERAND IS DOUBLE PRECISION, so
4876
05440
THE FAC MUST BE FORCED TO DOUBLE PRECISION, MOVED INTO ARG
4877
05460
;
AND THE STACK VALUE POPED INTO THE FAC
4878
05480
;
4879
005725
001000
000315
05500
STKDBL: CALL
FRCOBL
;MAKE THE FAC DOUBLE PRECISION
4880
005726
000000
000664*
4881 005727 000000
005721
4882 005730 001000
060315
05520
CALL
VMOVAF
;MOVE THE FAC INTO ARG
4883 005731 000000
000600*
4884 005732' 000000
005726
4885 005733 001000
000341
05540
POP
H
;POP OFF THE STACK OPERAND INTO THE FAC
4886 005734 001000
000042
05560
SHLD
DFACL0+2
4887 005735 000000
001635'
4888 005736 000000
005731
4889 005737 001000
000341
05580
POP
H
4890 005740 001000
000042
05600
SHLD
DFACLO
;STORE LOW BYTES AWAY
4891 005741 000000 001633
4892 005742' 000000 005735'
4893 005743 001000 000301
05620
SNGDBL: POPR
;POP OFF A FOUR BYTE VALUE