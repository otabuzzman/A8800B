
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47 (113) 03:12 10-SEP-75 PAGE 18-3
F3
MAC
6-SEP-64 03:11
INPUT AND READ CODE
4148 005016 000000 005011
4149 005017 001000 000076
59580
MVI
A, "?"
4150 005020 000000 000077
4151 005021 001000 000337
59600
OUTCHR
;DOUBLE PROMPT WHEN WE NEED MORE INPUT
4152 005022' 001000 000315
59620
CALL
QINLIN
;GET A WHOLE LINE AFTER TYPING "?"
4153 005023 000000 002522'
4154
005024 000000 005015
4155
59640
;THE DATA NOW STARTS AT THE BEGINNING
4156
59660
;OF THE BUFFER
4157
59680
AND QINLIN LEAVES [H,L]=BUF
4158
005025'
59700
DATBK:
4159
59720
IFE
LENGTH,. <POP
D
;POP OFF POINTER TO THE VARIABLE
4160
59740
INX
H
;FUDGE CHARACTER POINTER
4161
59760
CALL
REDINP>
;READ A VALUE USING "LET" CODE
4162
59780
IFN
LENGTH,<
4163
59800
IFN
STRING,<
4164
005025 001000
000072
59820
LDA
VALTYP
ISEE IF ITS NUMERIC OR STRING
4165
005026
000000
001543
4166
005027
000000
005023
4167
59840
IFE
LENGTH-21 <
4168 005030 001000 000376
59860
CPI
3
;IS IT A STRING ?
4169 005031 000000 000003
4170 005032' 001000 000365
59880
PUSH
PSW
;SAVE THE TYPE INFORMATION
4171
005033 001000 000302
59900
JNZ
NUMINS>
;IF NUMERIC,USE FIN TO GET IT
4172
005034 000000 005070
4173
005035' 000000 005026
4174
59920
IFN
LENGTH-2
<
4175
59940
ORA
A
4176
59960
JZ
NUMINS>
;INPUT A NUMBER IF NUMERIC
4177
59980
JONLY THE VARAIBLE TYPE IS
4178
60000
;CHECKED so AN UNQUOTED STRING
4179
60020
ICAN BE ALL DIGITS
4180
005036
001000
000327
60040
CHRGET
4181
005037
001000
000127
60060
MOV
D,A
;ASSUME QUOTED STRING
4182
005040
001000
000107
60080
MOV
B,A
ISETUP TERMINATORS
4183
005041 001000
000376
60100
CPI
34
QUOTE ?
4184
005042
000000
000042
4185 005043 001000
000312
60120
JZ
NOWGET
TERMINATORS OK
4186 005044 000000
005053
4187 005045 000000
005034
4188 005046 001000
000026
60140
MVI
D,":"
;UNQUOTED STRING TERMINATORS
4189
005047 000000
080072
4190
005050 001000
000006
60160
MVI
8,44
IARE COLON AND COMMA
4191
005051
000000
000054
4192
60180
DCX
H
1BACKUP SINCE START CHARACTER MUST BE INCLUDED
4193
005052' 001000 000053
4194
60200
;IN THE QUOTED STRING CASE WE DON'T WANT TO
4195
60220
INCLUDE THE STARTING OR ENDING QUOTE
4196
005053 001000 000315
60240
NOWGET: CALL
STRLT2
;MAKE A STRING DESCRIPTOR FOR THE VALUE
4197
005054 000000 007643
4198
005055' 000000 005044
4199
60242
;AND COPY IF NECESSARY
4200
60260
IFE
LENGTH-2,
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 18-4
F3
MAC
6-SEP-64 03:11
INPUT AND READ CODE
4201 005056 001000 000361
60280
DOASIG: POP
PSW>
IPOP OFF THE TYPE INFORMATION
4202
005057
001000
000353
60320
XCHG
1(0,E)=TEXT POINTER
4203 005060 001000 000041
60340
LXI
H,STRDN2
;RETURN LOC
4204 005061 000000
005077
4205 005062 000000
005054
4206 005063 001000
000343
60360
XTHL
;CH,LJ=PLACE TO STORE VARIABLE VALUE
4207 005064 001000
000325
60380
PUSH
D
;TEXT POINTER GOES ON
4208 005065 001000
000303
60400
JMP
INPCOM>
100 ASSIGNMENT
4209
005066 000000
004157
4210 005067 000000
005061
4211 005070 001000
000327
60420
NUMINS: CHRGET
4212 005071 001000 000315
60440
CALL
FIN
4213 005072 000000 000000*
4214 005073 000000 005066
4215
60460
IFE
LENGTH-2,<
4216 005074 001000 000303
60480
JMP
DOASIG>
;ASSIGNMENT IS COMPLICATED
4217
005075 000000 005056
4218
005076 000000 005072
4219
60500
EVEN FOR NUMERICS so USE THE "LET" CODE
4220
60520
IFN
LENGTH-2
4221
60540
XTHL
[H,L] GET POINTER AT VARIABLE
4222
60560
CALL
MOVMF
100 THE ASSIGNMENT
4223
60580
POP
H>>
;GET BACK THE TEXT POINTER
4224
005077
60600
STRON2:
4225
60620
IFN
LENGTH,
<
4226
005077
001000
000053
60640
DCX
H
4227 005100' 001000 000327
60660
CHRGET
4228
005101
001000
000312
60680
JZ
TRMOK
4229
005102* 000000
005111
4230 005103 000000 005075'
4231 005104 001000
000376
60700
CPI
44
4232 005105 000000
000054
4233 005106 001000
000302
60720
JNZ
TRMNOK>
TENDED PROPERLY?
4234
005107
000000
004667
4235 005110 000000
005102'
4236 005111 001000
000343
60740
TRMOK:
XTHL
4237 005112' 001000
060053
60760
DCX
H
BLOOK AT TERMINATOR
4238 005113 001000 000327
60780
CHRGET
;AND SET UP CONDITION CODES
4239 005114 001000 000302
60800
JNZ
LOPOT2
NOT ENDING, CHECK FOR COMMA
4240 005115 000000 004773'
4241
005116
000000
005107
4242
60820
AND GET ANOTHER VARIABLE
4243
60840
;TO FILL WITH DATA
4244
4245
005117
001000
000321
60880
POP
D
;POP OFF THE POINTER INTO DATA
4246 005120 001000 000072
60900
LDA
FLGINP
1FETCH THE STATEMENT TYPE FLAG
4247 005121 000000 001602'
4248 005122' 000000 005115'
4249 005123 001000 060267
60920
ORA
A
4250
60940
IFE
LENGTH, <RZ>
;DON'T UPDATE DATPTR IF IT WAS AN
4251
60960
;INPUT STATEMENT
4252 005124 001000 000353
60980
XCHG
4253 005125 001000 060302
61000
JNZ
RESFIN
RUPDATE DATPTR
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47 (113) 03:12 10-SEP-75 PAGE 18-5
F3
MAC
6-SEP-64 03:11
INPUT AND READ CODE
4254 005126 000000 003453
4255 005127 000000 005121
4256
61020
IFN
LENGTH,
4257
005130
001000
000266
61040
ORA
M
COULD HAVE ENDED WITH COMMA OR
4258
61060
ICOLON, BUT SHOULD BE A ZERO
4259
005131 001000
000041
61080
LXI
EXIGNT
;TEXT FOR "EXTRA"
4260
005132' 000000
005142'
4261
005133 000000
005126
4262
005134 001000
000325
61100
PUSH
D
;SAVE THE TEXT POINTER
4263
005135' 001000
000304
61120
CNZ
STROUT
IF WASN'T REAL END SAY SOMETHING
4264
005136 000000
007743
4265
005137 000000
005132'
4266
005140 001000
000341
61140
POP
H
;GET BACK THE TEXT POINTER
4267
005141 001000
000311
61160
RET
4268
005142' 000000
000077
61180
EXIGNT: DC"?EXTRA IGNORED"
4269
005143 000000
060105
4270
005144 000000
000130
4271
005145 000000
000124
4272
005146 000000
000122
4273
005147 000000
000101
4274
005150 000000
000040
4275 005151 000000
000111
4276
005152 000000
000107
4277 005153 000000
000116
4278
005154 000000
000117
4279
005155' 000000
000122
4280
005156' 000000
000105
4281
005157 000000
000104
4282
005157 000000
000304
4283
005160 000000
000615
61200
ACRLF
4284
005161 000000
000012
4285
005162
000000
000000
61220
0>
4286
61240
4287
61260
SUBROUTINE TO FIND DATA
4288
61280
IN THE 4K "DATA" MUST BE AT THE START OF THE LINE
4289
61300
SO THE SEARCH IS MADE USING THE LINKS AT THE START OF EACH LINE.
4290
61320
4291
61340
;
IN THE 8K AND EXTENDED THE SEARCH IS MADE BY USING THE EXECUTION CODE
4292
61360
;
FOR DATA TO SKIP OVER STATEMENTS. THE START WORD OF EACH STATEMENT
4293
61380
;
IS COMPARED WITH DATATK. EACH NEW LINE NUMBER
4294
61400
;
IS STORED IN OATLIN so THAT IF AN ERROR OCCURS WHILE READING
4295
61420
;
DATA THE ERROR MESSAGE WILL GIVE THE LINE NUMBER OF THE
4296
61440
;
ILL-FORMATTED DATA
4297
61460
,
4298
005163 001000
000315
61480
DATLOP: IFN
LENGTH,<CALL
DATA>
4299
005164 000000 004072
4300
005165' 000000 005136
4301
61500
IFE
LENGTH, <POP
H>
4302
005166
61520
DATEND: IFN
LENGTH,
4303 005166 001000 000267
61540
ORA
A
4304
005167 001000 000302
61560
JNZ
NOWLIN>
4305 005170 000000 005214
4306 005171 000000 005164
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47 (113) 03:12 10-SEP-75 PAGE 18-6
F3
MAC
6-SEP-64 03:11
INPUT AND READ CODE
4307
61580
IFN
LENGTH, <
4308
005172'
001000
000043
61600
INX
H>
4309
005173
001000
000367
61620
PUSHM
;SAVE POINTER TO THE NEXT STATEMENT
4310
005174
001000
000171
61640
MOV
A,C
ISEE IF WE ARE AT THE END
4311 005175' 001000
000260
61660
ORA
B
4312
005176 001000
000636
61680
MVI
E,ERROD
INO DATA IS ERROR ERROD
4313 005177 000000
000004
4314
005200 001000
000312
61700
JZ
ERROR
;IF so COMPLAIN
4315 005201 000000
002102'
4316 005202' 000000
005170
4317
61720
IFE
LENGTH, <INX
H>
;SKIP PAST LINE #
4318
005203 001000
060301
61740
IFN
LENGTH, <POP
8
4319
005204 001000
000136
61760
MOV
E,M
IGET DATA LINE #
4320
005205 001000
060643
61780
INX
H
4321
005206 001000
000126
61800
MOV
D,M
4322 005207 001000
000353
61820
XCHG
4323 005210 001000
000042
61840
SHLD
DATLIN
4324 005211 000000
001577째
4325 005212' 000000
005201
4326 005213 001000
000353
61860
XCHG>
IRESTORE TEXT POINTER
4327 005214 001000
000327
61880
NOWLIN:
CHRGET
;GET THE STATEMENT TYPE
4328 005215 001000
000376
61900
CPI
DATATK
,IS IS "DATA"?
4329 005216 000000
000203
4330
005217째 001000
000302
61920
JNZ
DATLOP
NOT DATA so LOOK SOME MORE
4331
005220 000000
005163
4332
005221 000000
005211
4333
61940
IFE
LENGTH, <POP
B>
4334
005222' 001000
000303
61960
JMP
DATBK
;CONTINUE READING
4335
005223' 000000
005025'
4336
005224
000000
005220
4337
4338
4339
4340
62040
PAGE
0
.
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 7(113) 03:12 10-SEP-75 PAGE 19
F3
MAC
6-SEP-64 03:11
NEXT CODE
4341
62060
SUBTTL NEXT CODE
4342
62080
4343
62100
NOTE:
4344
62120
4345
62140
4346
62160
A FOR ENTRY ON THE STACK HAS THE FOLLOWING FORMAT:
4347
62180
4348
62200
4349
62220
LOW ADDRESS
4350
62240
TOKEN (FORTK IN HIGH BYTE) 1 BYTES
4351
62260
A POINTER TO THE LOOP VARIABLE 2 BYTES
4352
62280
A BYTE REFLECTING THE SIGN OF THE INCREMENT 1 BYTE
4353
62300
THE STEP 4 BYTES
4354
62320
THE UPPER VALUE 4 BYTES
4355
62340
THE LINE # OF THE "FOR" STATEMENT 2 BYTES
4356
62360
A TEXT POINTER INTO THE "FOR" STATEMENT 2 BYTES
4357
62380
HIGH ADDRESS
4358
62400
4359
62420
TOTAL 16 BYTES
4360
62440
4361
005225'
62460
NEXT:
4362 005225' 001000 000021
62480
IFN
LENGTH, <LXI
O,SCODE>:FOR THE "NEXT"
4363 005226 000000 000000
4364
005227
000000
005223
4365
62500
;STATEMENT WITHOUT ANY ARGS
4366
62520
;WE CALL FNDFOR WITH (D,E)
4367
005230
62540
NEXTC:
4368
62560
IFE
LENGTH,
4369
62580
CALL
PIRGET>
IMUST HAVE A VARIABLE
4370
62600
IFN
LENGTH,
4371
005230 001000 000304
62620
CNZ
PIRGET>
;GET A POINTER TO THE
4372
005231' 000000 006505'
4373 005232' 000000 005226'
4374
62640
;LOOP VARIABLE INTO (D,E)
4375
005233'
001000
000042
62660
SHLD
TEMP
;PUT THE TEXT POINTER
4376
005234 000000 001603
4377
005235' 000000 005231
4378
62680
;IN A TEMP LOCATION
4379
62700
IIN CASE THE LOOP TERMINATES
4380
005236 001000
000315
62720
CALL
FNDFOR
STRY TO FIND A FOR ENTRY
4381
005237 000000 001744
4382
005240 000000
005234
4383
62740
;ON THE STACK WHOSE VARIABLE NAME
4384
62760
;MATCHES THIS ONES
4385
62780
IFN
LENGTH,
4386
005241 001000 000302
62800
JNZ
NFERR>
"NEXT WITHOUT FOR"
4387
005242' 000000 002100
4388 005243 000000 005237
4389 005244 001000 000371
62820
SPHL
;SETUP STACK POINTER BY CHOPPING
4390
62840
;AT THIS POINT
4391
005245' 001000 060325
62860
PUSH
0
1PUT THE VARIABLE PTR BACK ON
4392 005246 001000 000176
62880
MOV
A,M
1STEP ONTO THE STACK
4393
005247 001000 000643
62900
INX
H
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 19-1
F3
MAC
6-SEP-64 03:11
NEXT CODE
4394
005250 001000 000365
62920
PUSH
PSW
4395
005251 001000 000325
62940
PUSH
0
;PUT THE POINTER TO THE LOOP
4396
62960
1 VARIABLE ONTO THE STACK
4397
62980
IFE
LENGTH,
4398
63000
MVI
E,ERRNF
4399
63020
JNZ
ERROR>
4400 005252' 001000 000315
63040
CALL
MOVFM
1STEP VALUE INTO THE FAC
4401 005253 000000 000000*
4402 005254 000000 005242
4403 005255' 001000 000343
63060
XTHL
;PUT THE POINTER INTO THE
4404
63080
IFOR ENTRY ONTO THE STACK
4405
005256' 001000
000345
63100
PUSH
H
IPUT THE POINTER TO THE LOOP
4406
63120
;VARIABLE BACK ONTO THE STACK
4407
005257 001000
000315
63140
CALL
FADDS
BADD THE STEP AND LOOP VARIABLE
4408 005260째 000000 000000*
4409 005261 000000 005253'
4410 005262' 001000 060341
63160
POP
H
;POP OFF THE POINTER TO
4411
63180
;THE LOOP VARIABLE
4412
005263 001000
000315
63200
CALL
MOVMF
;MOV FAC INTO LOOP VARIABLE
4413 005264 000000
000000*
4414 005265' 000000
005260
4415 005266 001000
000341
63220
POP
H
;GET THE ENTRY POINTER
4416 005267 001000
000315
63240
CALL
MOVRM
;GET THE FINAL INTO THE REGISTERS
4417 005270 000000
060000*
4418 005271 000000
005264
4419 005272' 001000
000345
63260
PUSH
H
;SAVE THE ENTRY POINTER
4420 005275 001000
000315
63280
CALL
FCOMP
;COMPARE THE NUMBERS
4421 005274 000000
000714*
4422 005275 000000
005270
4423 005276 001000
000341
63300
POP
H
;STILL POINTING TO THE FINAL VALUE
4424 005277 001000
060301
63320
POP
B
;GET THE SIGN OF THE INCREMENT
4425 005300 001000
080220
63340
SUB
B
;SUBTRACT THE INCREMENTS SIGN FROM THAT
4426
63360
;OF (CURRENT VALUE- INAL VALUE)
4427
005301 001000
000315
63380
CALL
MOVRM
IGET LINE # OF "FOR" INTO [D,E]
4428 005302' 000000
005270*
4429
005303' 000000
005274
4430
63400
IGET TEXT POINTER OF "FOR" INTO (B,C)
4431
005304 001000
000312
63420
JZ
LOOPON
;IF SIGNCFINAL-CURRENT)+SIGN(STEP)
4432
005305' 000000
005320'
4433
005306 000000
005302'
4434
63440
;THEN THE LOOP IS FINISHED
4435
005307 001000
000353
63460
XCHG
4436 005310 001000
060642
63480
SHLD
CURLIN
;STORE THE LINE #
4437 005311 000000
001607
4438 005312' 000000
005305'
4439 005313 001000
000151
63500
MOV
L.C
SETUP THE TEXT POINTER
4440 005314 001000
000140
63520
MOV
H,B
4441 005315 001000
000303
63540
JMP
NXTCON
4442
005316 000000
003276
4443
005317 000000
005311
4444
4445
005320째 001000 000371
63580
LOOPDN: SPHL
ELIMINATE THE FOR ENTRY
4446
63600
;SINCE [H,L] MOVED ALL
BASIC MCS 8080
GATES/ALLEN/DAVIDOFE
MACRO 47(113) 03:12 10-SEP-75 PAGE 19-2
F3
MAC
6-SEP-64 03:11
NEXT CODE
4447
63620
;THE WAY DOWN THE ENTRY
4448
005321 001000
000052
63640
LHLD
TEMP
IRESTORE THE TEXT POINTER
4449
005322' 000000
001603
4450
005323 000000
005316
4451
63660
IFE
LENGTH, <JMP
NEWSTT>
4452
63680
IFN
LENGTH,<
4453
005324 001000
060176
63700
MOV
A,M
;IS THERE A COMMA AT THE END
4454
005325 001000
000376
63720
CPI
44
;IF so LOOK AT ANOTHER
4455
005326 000000
000054
4456
005327 001000
000302
63740
JNZ
NEWSTT
;VARIABLE NAME TO "NEXT"
4457
005330 000000
003302'
4458
005331 000000
005322'
4459
005332' 001000
000327
63760
CHRGET
;READ FIRST CHARCTER
4460
005333 001000
000315
63780
CALL
NEXTC>
100 NEXT, BUT DON'T ALLOW
4461
005334
000000
005230
4462
005335'
000000
005330
4463
63800
;BLANK VARIABLE NAME (D,E)=STK PTR
4464
63820
AND WILL NEVER MATCH ANY VARPTR
4465
63840
USE CALL TO PUT DUMMY "NEWSTT" ENTRY ON
4466
4467
63880
PAGE
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 20
F3
MAC
6-SEP-64 03:11
NEXT CODE
4468
4469
.