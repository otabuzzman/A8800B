
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47 (113) 03:12 10-SEP-75 PAGE 9m1
F3
MAC
6-SEP-64 03:11
THE "LIST" COMMAND
2708
2709
2710
39520 PAGE
BASIC MCS 8080 GATES/ALLEN/DAVIDOFR
MACRO 47(113) 03:12 10-SEP-75 PAGE 10
F3
MAC
6-SEP-64 03:11
"FOR" STATEMENT
2711
39540
SUBTTL "FOR" STATEMENT
2712
39560
;
2713
39580
NOTE:
2714
39600
2715
39620
A FOR ENTRY ON THE STACK HAS THE FOLLOWING FORMAT:
2716
39640
2717
39680
2718
39700
LOW ADDRESS
2719
39720
TOKEN (FORTK IN HIGH BYTE) 1 BYTE
2720
39740
A POINTER TO THE LOOP VARIABLE 2 BYTES
2721
39760
A BYTE REFLECTING THE SIGN OF THE INCREMENT 1 BYTE
2722
39780
THE STEP 4 BYTES
2723
39800
THE UPPER VALUE 4 BYTES
2724
39820
THE LINE # OF THE "FOR" STATEMENT 2 BYTES
2725
39840
A TEXT POINTER INTO THE "FOR" STATEMENT 2 BYTES
2726
39860
HIGH ADDRESS
2727
39880
2728
39900
TOTAL 16 BYTES
2729
39920
;
2730
2731 0031549
39960
FOR:
IFN
LENGTH, <
2732
003154 001000
000076
39980
MVI
A,100
2733
003155' 000000
000144
2734 003156 001000 000062
40000
STA
SUBFLG>
IDONT RECOGNIZE SUBSCRIPTED VARIABLES
2735 003157' 000000 001601
2736
003160 000000
003151
2737 003161 001000 000315
40020
CALL
LET
,READ THE VARIABLE AND ASSIGN IT
2738
003162' 000000 004131
2739
003163' 000000 003157
2740
40040
,THE CORRECT INTIAL VALUE
2741
40060
;AND STORE A POINTER
2742
40080
ITO THE VARIABLE IN (TEMP)
2743
003164 001000
000343
40100
XTHL
;SAVE TEXT PTR ON THE STACK
2744
003165' 001000
000315
40120
CALL
FNDFOR
MUST HAVE VARIABLE POINTER IN (D,E)
2745
003166 000000
001744
2746 003167 000000
003162'
2747
003170 001000
000321
40140
POP
D
1(0,E)=TEXT POINTER
2748 003171 001000 000302
40160
JNZ
NOTOL
;IF NO MATCHING ENTRY, DON'T
2749
003172' 0.0000
003176
2750 003173 000000 003166
2751
40180
ELIMINATE ANYTHING
2752
003174 001000 000011
40200
DAD
8
;IN THE CASE OF "FOR"
2753
40220
;WE ELIMINATE THE MATCHING ENTRY
2754
40240
IAS WELL AS EVERYTHING AFTER IT
2755 003175' 001000 000371
40260
SPHL
100 THE ELIMINATION
2756
40280
;SINCE A MATCHING ENTRY WAS FOUND
2757 003176 001000 000353
40300
NOTOL:
XCHG
: [H,L]=TEXT POINTER
2758 003177° 001000 060315
40320
CALL
GETSTK
2759 003200 000000 002024
2760 003201 000000 003172'
2761 003202' 000000 000010
40340
8
;MAKE SURE 16 BYTES ARE AVAILABLE
2762
40360
;OFF OF THE STACK
2763 003203 001000 000345
40380
PUSH
H
;REALLY SAVE THE TEXT POINTER
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 10-1
F3
MAC
6-SEP-64 03:11
"FOR" STATEMENT
2764 003204 001000 000315
40400
CALL
DATA
;GET AN (H,L) THAT POINTS
2765
003205' 000000 004072
2766
003206 000000 063200
2767
40420
;JUST BEYOND THE TERMINATOR
2768
003207
001000
000343
40440
XTHL
;PUT [H,L] POINTER 10 TERMINATOR ON THE STACK
2769
40460
BAND RESTORE [H,L] AS TEXT POINTER AT
2770
40480
AVARIABLE NAME
2771 003210 001000 000345
40500
PUSH
H
;PUSH THE TEXT POINTER ONTO THE STACK
2772 003211 001000 000052
40520
LHLD
CURLIN
; [H,L] GET THE CURRENT LINE #
2773
003212
000000
001607
2774
003213
000000
003205'
2775
003214
001000
000343
40540
XTHL
;NOW THE CURRENT LINE # IS ON THE STACK AND
2776
40560
REH,L) IS THE TEXT POINTER
2777
40580
IFN
LENGTH-2,<
2778
40600
IFN
STRING,<CALL
CHKNUM>>
2779
003215 001000 000317
40620
SYNCHK TOTK
" TO" IS NECESSARY
2780
003216
000000
000241
2781
40640
IFN
LENGTH-2,
2782
40660
CALL FRMNUM>
;READ FINAL VALUE
2783
40680
IFE
LENGTH-2,<
2784
003217
001000
000315
40700
CALL
FRMEVL>
2785
003220
000000
005336
2786
003221'
000000
003212'
2787
003222'
001000
000345
40720
PUSH
H
;SAVE THE TEXT POINTER
2788
40740
IFE
LENGTH-2,<
2789
003223' 001000
000315
40760
CALL
FRCSNG>
2790
003224 000000
000670*
2791 003225' 000000
003220
2792
003226* 001000
000315
40780
CALL
MOVRE
:GET THE STUFF
2793
003227 000000
000000*
2794
003230 000000
003224*
2795
003231 001000
000341
40800
POP
H
IREGAIN TEXT POINTER
2796
003232 001000
000305
40820
PUSH
B
;OPPOSITE OF PUSHR
2797
003233 001000
000325
40840
PUSH
0
1SAVE THE SIGN OF THE INCREMENT
2798
003234 001000
000001
40860
LXI
B,SCODE+*0201*256
2799
003235 000000
1004001
2800
003236 000000
003227
2801
003237 001000
000121
40880
MOV
D,C
2802
003240 001000
000132
40900
MOV
E,O
;GET 1.0 IN THE REGISTERS
2803
003241 001000
000176
40920
MOV
A,M
IGE1 TERMINATING CHARACTER
2804
003242' 001000
000376
40940
CPI
STEPTK
100 WE HAVE "STEP" ?
2805
003243 000000
000247
2806
003244 001000
060676
40960
MVI
A,1
;SETUP DEFAULT SIGN
2807
003245 000000
000001
2808
003246 001000
000302
40980
JNZ
ONEON
;PUSH SOME CONSTANTS ON IF NOT
2809
003247 000000
003265
2810
003250 000000
003235
2811
41000
IFN
LENGTH-2,
2812
41020
IFN
STRING,
2813
41040
CHRGET
2814
41060
CALL
FRMNUM>>
READ THE STEP
2815
41080
IFE
<LENGTH-2>&STRING,<
2816
003251 001000 000315
41100
CALL
FRMCHK>
IDON'T NEED TO CHECK THE TYPE
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 10-2
F3
MAC
6-SEP-64 03:11
"FOR" STATEMENT
2817
003252'
000000
005337
2818
003253'
000000
003247
2819
003254
001000
000345
41120
PUSH
H
2820
41140
IFE
LENGTH-21
2821
003255'
001000
000315
41160
CALL
FRCSNG>
2822
003256
000000
003224*
2823
003257 000000
003252'
2824
003260 001000
000315
41180
CALL
MOVRF
ISE1 UP THE REGISTERS
2825
003261 000000
003227*
2826
003262 000000
003256
2827
003263 001000
000341
41200
POP
H
2828
003264 001000
000357
41220
FSIGN
IGET THE SIGN OF THE INCREMENT
2829
003265 001000
000305
41240
ONEON:
PUSH
8
IPUT VALUE ON BACKWARDS
2830
003266 001000
000325
41260
PUSH
0
;OPPOSITE OF PUSHR
2831
003267 001000
000365
41280
IFORDN:
PUSH
PSW
;SAVE THE SIGN OF THE INCREMENT
2832
003270 001000
000063
41300
INX
SP
IA ONE BYTE ENTRY ONLY
2833
003271 001000
000345
41320
PUSH
H
2834
003272 001000
000052
41340
LHLD
TEMP
;GET THE POINTER TO THE VARIABLE BACK
2835
003273* 000000
001603
2836
003274 000000
003261
2837
003275
001000
000343
41360
XTHL
1PUT THE POINTER TO THE VARIABLE
2838
41380
IONTO THE STACK AND RESTORE THE TEXT POINTER
2839
003276 001000
000606
41400
NXTCON: MVI
B,FORTK
;PUT A 'FOR TOKEN ONTO THE STACK
2840
003277
000000
000201
2841
003300
001000
000305
41420
PUSH
8
2842
003301
001000
000063
41440
INX
SP
,THE "TOKEN" ONLY TAKES ONE BYTE OF
2843
41460
1STACK SPACE
2844
41480
;
JMP
NEWSTT
BALL DONE
2845
41500
PAGE
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 11
F3
MAC
6-SEP-64 03:11
NEW STATEMENT FETCHER
2846
41520
SUBTTL NEW STATEMENT FETCHER
2847
41540
,
2848
41560
; BACK HERE FOR NEW STATEMENT. CHARACTER POINTED TO BY (H,L)
2849
41580
;
":" OR END-OF-LINE. THE ADDRESS OF THIS LOCATION IS
2850
41600
; LEFT ON THE STACK WHEN A STATEMENT IS EXECUTED so
2851
41620
; IT CAN MERELY DO A RETURN WHEN IT IS DONE.
2852
41640
;
2853
003302'
41660
NEWSTT:
2854
41680
IFN
LISTEN, <
2855
41700
IFN
LENGTH,
2856
003302' 001000
000333
41720
IN
0
;CHECK FOR A CHARACTER WITHOUT
2857
003303 000000
060000
2858
41740
,DOING A "CALL" FOR SPEED
2859
003303
41760
CNLCA4==:,-1
2860
003304 001000
000346
41780
ANI
IDONE
;CHARACTER THERE?
2861
003305' 000000
000001
2862
003306 001000
000314
41800
CZ
CNTCCN>
;SEE IF IT'S CONTROL-C
2863
003307 000000
003465'
2864
003310
000000
003273
2865
41820
IFE
LENGTH,
2866
41840
CALL
ISCNTC
2867
41860
IFN
LENGTH,
2868
003311' 001000 000042
41880
SHLD
TEMP>
;USED BY CONTINUE AND INPUT AND CLEAR
2869
003312' 000000 001603
2870
003313 000000 003307
2871
41900
ITO REMEMBER HOW TO RESTART THIS
2872
41920
:STATEMENT
2873
41940
IFN
LPTSW,<XRA
A
;FORCE PRINT TO GO TO TTY AFTER LPRINT
2874
41960
STA
PRTFLG>
2875
003314 001000 060176
41980
MOV
A,M
;GET CURRENT CHARACTER
2876
42000
;WHICH TERMINATED THE LAST STATEMENT
2877
003315 001000
000376
42020
CPI
":"
1IS IT A COLON?
2878 003316 000000
000072
2879 003317 001000
000312
42040
JZ
GONE
2880 003320 000000
003370
2881 003321' 000000
003312'
2882 003322' 001000
000267
42060
ORA
A
2883 003323' 001000
000302
42080
JNZ
SNERR
;MUST BE A ZERO
2884 003324 000000
002072'
2885
003325' 000000
003320*
2886
003326' 001000
000043
42100
INX
H
2887
003327' 001000
000176
42120
MOV
A,M
;CHECK POINTER TO SEE IF
2888
42140
IIT IS ZERO, IF so WE ARE AT THE
2889
42160
TEND OF THE PROGRAM
2890
003330 001000
000043
42180
INX
H
2891
003331 001000
000266
42200
ORA
M
10R IN HIGH PART
2892 003332' 001000
000043
42220
INX
H
2893 003333° 001000
000312
42240
JZ
ENDCON
IRAN OFF THE END -- OK
2894 003334' 000000
003501
2895 003335' 000000
003324
2896 003336' 001000
000136
42260
MOV
E,M
2897
003337' 001000
000043
42280
INX
H
2898
003340° 001000
000126
42300
MOV
D,M
;GET LINE # IN [0,E]
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 11-1
F3
MAC
6-SEP-64 03:11
NEW STATEMENT FETCHER
2899 003341 001000 000353
42320
XCHG
ICH,LI=LINE #
2900 003342' 001000 000042
42340
SHLD
CURLIN
ISETUP CURLIN WITH THE CURRENT LINE #
2901 003343 000000 001607
2902 003344 000000 003334
2903
42360
IFE
LENGTH-2,
;TRACE FEATURE
2904 003345 001000
000672
42380
LDA
TRCFLG
ISEE IF TRACE IS ON
2905 003346 000000
001631
2906 003347 000000
003343
2907 003350 001000
000267
42400
ORA
A
;NON-ZERO MEANS YES
2908 003351 001000
000312
42420
JZ
NOTTRC
;SKIP THIS PRINTING
2909 003352' 000000
003367
2910 003353' 000000
003346
2911 003354* 001000
000325
42440
PUSH
D
;SAVE THE TEXT POINTER
2912 003355' 001000
000076
42460
MVI
A,"C"
;FORMAT THE LINE NUMBER
2913 003356 000000
000133
2914 003357 001000
000337
42480
OUTCHR
;OUTPUT IT
2915 003360 001000
000315
42500
CALL
LINPRT
PRINT THE LINE IN [H,L]
2916 003361 000000
000000*
2917 003362' 000000
003352
2918 003363 001000
000076
42520
MVI
A,"]"
;SOME MORE FORMATING
2919 003364 000000
000135
2920 003365' 001000
000337
42540
OUTCHR
2921 003366* 001000
000321
42560
POP
D
, ] =TEXT POINTER
2922 003367
42580
NOTTRC:>
2923 003367 001000
000353
42600
XCHG
RESTORE THE TEXT POINTER
2924 003370 001000
000327
42620
GONE:
CHRGET
;GET THE STATEMENT TYPE
2925 003371 001000
000021
42640
LXI
D,NEWSTT
;PUSH ON A RETURN ADDRESS OF NEWSTT
2926 003372' 000000
003302'
2927 003373 000000
003361
2928 003374 001000
000325
42660
PUSH
D
;STATEMENT
2929 003375 001000
000310
42680
GONE 3:
RZ
IIF A TERMINATOR TRY AGAIN
2930
42700
;"IF" COMES HERE
2931 003376 001000
000326
42720
GONE2:
SUI
ENDTK
;"ON GOTO" AND "ON GOSUB" COME HERE
2932 003377 000000
000200
2933 003400 001000
000332
42740
JC
LET
MUST BE A LET
2934 003401 000000
004131
2935
003402' 000000
003372'
2936
000040
42760
NUMCMD=SCRATK-ENDTK+
2937 003403 001000
000376
42780
CPI
NUMCMD
2938 003404 000000
000040
2939 003405' 001000
000322
42800
JNC
SNERR
;SOME RESERVED WORD,BUT NOT
2940 003406 000000
002072
2941 003407 000000
003401
2942
42820
IA STATEMENT RESERVED WORD
2943 003410 001000
000007
42840
RLC
MULTIPLY BY 2
2944 003411 001000
000117
42860
MOV
C,A
2945 003412' 001000
000606
42880
MVI
8,0
2946 003413 000000
000000
2947 003414 001000
000353
42900
XCHG
2948 003415 001000
000041
42920
LXI
,STMDSP
STATEMENT DISPATCH TABLE
2949 003416 000000
000564°
2950 003417 000000 003406
2951 003420 001000 000011
42940
DAD
8
;ADD ON OFFSET
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 11-2
F3
MAC
6-SEP-64 03:11
NEW STATEMENT FETCHER
2952 003421 001000 000116
42960
MOV
C,M
:PUSH THE ADDRESS TO GO TO ONTO
2953 003422' 001000 000043
42980
INX
H
;THE STACK
2954 003423 001000 000106
43000
MOV
B,M
;PUSHM SAVES BYTES BUT NOT SPEED
2955 003424 001000 000305
43020
PUSH
8
2956
003425
001000
000353
43040
XCHG
RESTORE THE TEXT POINTER
2957
43060
IFE
LENGTH,
2958
43080
CHRGET
;EAT THE FIRST CHARACTER
2959
43100
RET>
IGO DO THE STATEMENT
2960
43120
IFN
LENGTH,
2961
003426 001000
000043
43140
CHRGTR: INX
H
1DUPLICATION OF CHRGET RST FOR SPEED
2962 003427 001000 000176
43160
MOV
A,M
;SEE CHRGET RST FOR EXPLANATION
2963 003430 001000 000376
43180
CPI
2964
003431 000000
000072
2965
003432' 001000
000320
43200
RNC>
2966
43220
2967
43240
;
CHRCON IS THE CONTINUATION OF THE CHRGET RST
2968
43260
;
2969
003433 001000
000376
43280
CHRCON: CPI
MUST SKIP SPACES
2970 003434 000000
080640
2971 003435' 001000
000312
43300
JZ
CHRGTR
;GET ANOTHER CHARACTER
2972 003436 000000
003426
2973 003437 000000
003416
2974 003440* 001000
000376
43320
CPI
"0"
;ALL CHARACTERS GREATER THAN
2975 003441 000000
000060
2976
43340
:"9" HAVE RETURNED, so SEE IF NUMERIC
2977 003442' 001000
060077
43360
CMC
IMAKE NUMERICS HAVE CARRY ON
2978 003443 001000
000074
43380
INR
A
;SET ZERO IF [A] =0
2979 003444 001000 000075
43400
DCR
A
2980
003445 001000
000311
43420
RET
2981
43440
PAGE
BASIC MCS 8080 GATES/ALLEN/DAVIOOFF
MACRO 17(113) 03:12 10-SEP-75 PAGE 12
F3
MAC
6-SEP-64 03:11
RESTORE,STOP,END,LINGET,CHRCON
2982
43460 SUBTTL RESTORE, STOP, END, LINGET, CHRCON
2983
2984
003446 001000
000353
43500
RESTOR: XCHG
;SAVE (H,L) IN (D,E)
2985
003447 001000
000052
43520
LHLD
TXTTAB
2986 003450 000000
001617
2987 003451 000000
003436
2988 003452' 001000
000053
43540
DCX
H
;INITIALIZE DATPTR TO (TXTTAB) -1
2989 003453 001000
000042
43560
RESFIN: SHLD
DATPTR
READ FINISHES COME TO RESFIN
2990 003454 000000
001627
2991 003455 000000
003450
2992
003456 * 001000
060353
43580
XCHG
;GET THE TEXT POINTER BACK
2993
003457 001000
000311
43600
RET
2994
2995
43640
IFN
LISTEN,
2996
003460 001000
000333
43660
ISCNTC: IN
0
2997
003461 000000
000000
2998
003461
43680
CNLCA3==
1CONSOLE COMMAND CHANGE LOC
2999 003462' 001000
000346
43700
ANI
IDONE
3000 003463 000000
000001
3001 003464° 001000
000300
43720
RNZ
;IF NO CHARACTERS THEN NO C
3002 003465 001000
000315
43740
CNTCCN: CALL
INCHR
3003 003466° 000000
003126
3004 003467 000000
003454
3005 003470 001000
000376
43760
CPI
3
;STOP CHARACTER IS -C
3006
003471 000000
000603
3007
43780
IFE
LENGTH,
3008
43800
JMP
STOP>>
3009
43820
IFN
LENGTH,
3010
003472 001000 000300
43840
STOP:
RNZ
;RETURN IF NOT CONTROL-C AND MAKE
3011
43860
;SURE "STOP" STATEMENTS HAVE A TERMINATOR
3012 003475 001000 000366
43880
XWD
01000,-0366
;SETUP [A] AS A FLAG WHETHER
3013
43900
iTO TYPE THE BREAK MESSAGE
3014 003474 001000
000300
43920
END:
RNZ
;MAKE SURE "END" STATEMENTS HAVE A TERMINATOR
3015
003475' 001000
000042
43940
SHLD
TEMP
ISAVE FOR "CONTINUE"
3016 003476 000000
001603
3017
003477° 000000
003466'
3018 003500 001000
000301
43960
STPEND: POP
B
;POP OFF NEWSTT ADDRESS
3019 003501 001000
000365
43980
ENDCON: PUSH
PSW
;SAVE THE MESSAGE FLAG
3020
44000
IZERO MEANS DON'T PRINT "BREAK"
3021
003502
001000
000052
44020
LHLD
CURLIN
;SAVE CURLIN
3022
003503 000000
061607
3023
003504
000000
003476
3024
003505 001000
000175
44040
MOV
A,L
3025 003506 001000
000244
44060
ANA
H
ISEE IF IT WAS DIRECT
3026 003507 001000
000074
44080
INR
A
3027 003510* 001000
000312
44100
JZ
DIRIS
;IF NOT SET UP FOR CONTINUE
3028 003511' 000000
003524
3029 003512 000000
003503
3030 003513 001000
000042
44120
SHLD
OLDLIN
;SAVE OLD LINE #
3031
003514 000000
001611
3032
003515
000000
003511
3033
003516
001000
000052
44140
LHLD
TEMP
;GET POINTER TO START OF STATEMENT
3034
003517
000000
061603