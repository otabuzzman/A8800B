
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 26-16
F3
MAC
6-SEP-64 03:11
STRING FUNCTIONS
7300 010772' 001000 000103
40440
MOV
B,E
;SAVE INIT LENGTH
7301 010773 001000 000004
40460
INR
8
7302 010774 001000 000005
40480
DCR
8
;SEE IF EQUAL TO ZERO
7303
40500
IFE
LENGTH-2,
7304 010775 001000 000300
40520
RNZ
7305
010776
40536
ILLFUN:
7306 010776 001000 000036
40540
FCERR:
MVI
E,ERRFC
7307 010777 000000 000005
7308 011000 001000 000303
40560
JMP
ERROR>
7309 011001 000000 002102'
7310 011002' 000000 010761
7311
40580
IFN
LENGTH-2,
7312
40600
JZ
FCERR
IIT MUST NOT BE 0
7313
40620
RET>
7314
40640
IFN
LENGTH,
7315
011003
001000
000315
40660
SETIO:
CALL
GETBYT
;GET INTEGER CHANNEL NUMBER IN [A]
7316
011004
000000
011020
7317 011005 000000 011001
7318 011006 001000
000662
40680
STA
STAINP+1
;SETUP "WAIT"
7319 011007 000000 010755
7320 0110109 000000
011004
7321 011011 001000
060062
40700
STA
OUTWRD+1
;SETUP "OUT"
7322 011012 000000
010731
7323
011013 000000
011007
7324
011014 001000
000317
40720
SYNCHK 44
;MAKE SURE THERE IS A COMMA
7325
011015 000000
000054
7326 011016 001000
060006
40740
XWD
-01000,6>
1"MVI 8, AROUND THE CHRGET
7327
40760
IFN
STRINGILENGTH,<
7328 011017 001000 000327
40780
GTBYTC: CHRGET
7329
40800
IFE
LENGTH-2,<
7330 011020 001000 000315
40820
GETBYT: CALL
FRMEVL
7331 011021 000000 065336
7332 011022' 000000 011012'
7333 011023 001000 000345
40840
CONINT: PUSH
H
7334 011024 001000 000315
40860
CALL
PROINT
7335 011025 000000 006441*
7336 011026 000000 011021
7337 011027 001000 000353
40880
XCHG
7338 011030 001000 000341
40900
POP
H>
7339
40920
IFN
LENGTH-2,
7340
40940
GETBYT: CALL
FRMNUM
;READ FORMULA INTO THE FAC.
7341
40960
CONINT: CALL
POSINT>
;CONVERT THE FAC TO A SINGLE BYTE INTEGER
7342 011031 001000 000172
40980
MOV
A,O
;SHOULD BE .LT. 255
7343 011032 001000 060267
41000
ORA
A
1SET CC'S
7344 011033 001000 060302
41020
JNZ
FCERR
;WASN'T ERROR
7345 011034 000000 010776
7346 011035' 000000 011025'
7347 011036 001000 000053
41040
DCX
H
;ACTUALLY FUNCTIONS CAN GET HERE
7348
41060
;WITH BAD (H,L) BUT NOT SERIOUS
7349
41080
;SET CONDITION CODES ON TERMINATOR
7350 011037 001000 060327
41100
CHRGET
7351 011040 001000 000173
41120
MOV
A,E
RETURN THE RESULT IN (A) AND (E)
7352 011041 001000 000311
41140
RET>
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47 (113) 03:12 10-SEP-75 PAGE 26-17
F3
MAC
6-SEP-64 03:11
STRING FUNCTIONS
7353
7354
41180
IFN
STRING,
7355
41200
;
7356
41202
; THE VAL FUNCTION TAKES A STRING AND TURN IT INTO
7357
41204
;
A NUMBER BY INTERPRETING THE ASCII DIGITS. ETC.
7358
41206
; EXCEPT FOR THE PROBLEM THAT A TERMINATOR MUST BE SUPPLIED
7359
41208
; BY REPLACING THE CHARACTER BEYOND THE STRING, VAL
7360
41210
; IS MERELY A CALL TO FLOATING INPUT (FIN).
7361
41212
;
7362
011042 001000
000315
41220
VAL:
CALL
LEN1
100 SETUP, SET RESULT=REAL
7363 011043 000000 010505
7364 011044 000000 011034
7365 011045 001000 000312
41240
JZ
ZERO
RETURN ZERO IF NULL
7366
011046 000000
000000*
7367
011047 000000 011043
7368
011050 001000
000137
41260
MOV
E,A
;GET LENGTH OF STR
7369
41270
IFN
LENGTH-2,<
7370
41280
INX
H>
;THIS IS ALL A KLUDGE
7371
011051
001000
000043
41300
INX
H
ITO HANDLE THE FACT THE IF
7372 011052 001000 000367
41320
PUSHM
;TWO STRINGS "1" AND "2"
7373 011053 001000 000140
41340
MOV
H,B
IARE STORED NEXT TO EACH OTHER
7374 011054 001000
000151
41360
MOV
L,C
;AND FIN IS CALLED POINTING TO
7375 011055' 001000
000631
41380
DAD
D
;THE FIRST TWELVE WILL BE RETURNED
7376 011056 001000
000106
41400
MOV
B,M
;THE IDEA IS TO STORE 0 IN THE
7377 011057 001000
000162
41420
MOV
M,D
;STRING BEYOND THE ONE VAL
7378 011060 001000
000343
41440
XTHL
;IS BEING CALLED ON
7379 011061 001000
000305
41460
PUSH
B
,THE FIRST CHARACTER OF THE NEXT STRING
7380 011062 001000
000176
41480
MOV
A,M
;GET FIRST CHARACTER OF ARGUMENT
7381 011063 001000
000315
41500
CALL
FIN
;TURN IT INTO A NUMBER IN THE FAC
7382 011064 000000 006103*
7383 011065 000000 011046
7384
011066 001000 000301
41520
POP
B
;GET THE MODIFIED CHARACTER OF THE NEXT
7385
41540
;STRING INTO [B]
7386
011067 001000 000341
41560
POP
H
;GET THE POINTER TO THE MODIFIED CHARACTER
7387
011070 001000 000160
41580
MOV
M,B
RESTORE THE CHARACTER
7388
41600
;IF STRING IS HIGHEST IN STRING SPACE
7389
41620
I WE ARE MODIFYING [MEMSIZ] AND
7390
41640
1THIS IS WHY [MEMSIZ] CAN'T BE USED TO STORE
7391
41660
;STRING DATA BECAUSE WHAT IF THE
7392
41680
;USER TOOK VAL OFF THAT HIGH STRING
7393
011071 001000 000311
41700
RET>
7394
7395
41740
PAGE
BASIC MCS 8080 GATES/ALLEN/DAVIDOFK
MACRO 47(113) 03:12 10-SEP-75 PAGE 27
F3
MAC
6-SEP-64 03:11
FANCY LIST,DELETE,EDIT,LLIST
7396
41760
SUBTTL FANCY DELETE, EDIT,LLIST
7397
41780
IFE
LENGTH-2,<
7398
41800
IFN
LPTSW,<
7399
41820
LLIST:
MVI
A,1
;GET NON ZERO VALUE
7400
41840
STA
PRTFLG>
;SAVE IN I/O FLAG
7401 011072' 001000
000301
41860
LIST:
POP
B
IGET RID OF NEWSTT RETURN ADDR
7402
011073
001000
000315
41880
CALL
SCNLIN
;SCAN LINE RANGE
7403
011074 000000
002333
7404
011075
000000
011064
7405 011076 001000
000305
41900
PUSH
8
;SAVE POINTER TO 1ST LINE
7406
011077 001000
000341
41920
LIST4:
POP
H
;GET POINTER TO LINE
7407
011100 001000
060321
41940
POP
D
;GET MAX LINE # OFF STACK
7408 011101 001000
000367
41960
PUSHM
;PUSH LINK
7409 0111021 001000
000170
41980
MOV
A,B
;SEE IF END OF CHAIN
7410 011103 001000
000261
42000
ORA
C
7411 011104 001000
000301
42020
POP
8
;GET LINK OFF STACK FOR ISCNTC
7412 011105* 001000
000312
42040
JZ
READY
;LAST LINE, STOP.
7413
011106 000000
002145
7414
011107 000000
011074
7415
42060
IFN
LISTEN,
7416 011110 001000
000315
42080
CALL
ISCNTC>
;CHECK FOR CONTROL-C
7417 011111 000000
003460
7418 011112' 000000
011106
7419 011113 001000
000305
42100
PUSH
8
;SAVE LINK BACK ON
7420 011114* 001000
000367
42120
PUSHM
;PUSH LINE
7421 011115* 001000
000343
42140
XTHL
;GET LINE # INTO [H,L]
7422 011116 001000
000353
42160
XCHG
;GET MAX LINE IN [H,L]
7423 011117 001000
060347
42180
COMPAR
PAST LAST LINE IN RANGE?
7424 011120' 001000
000301
42200
POP
8
;TEXT POINTER TO [B,C]
7425 011121 001000
000332
42260
JC
STPROY
;IF PAST, THEN DONE LISTING.
7426 011122' 000000
002144
7427 011123 000000
011111
7428 011124 001000
000343
42280
XTHL
;SAVE MAX ON BOTTOM OF STACK
7429 011125 001000
060345
42300
PUSH
H
;SAVE LINK ON TOP
7430
011126 001000
000305
42320
PUSH
8
;SAVE TEXT POINTER BACK
7431 011127 001000
000353
42340
XCHG
;GET LINE # IN [H,L]
7432
011130 001000
000315
42360
CALL
CRDO
100 CRLF TO START OUT
7433
011131 000000
004523*
7434
011132' 000000
011122'
7435
42380
;AND WE WANT [H,L] ON THE STACK
7436
011133' 001000
000315
42400
CALL
LINPRT
;PRINT AS INT WITHOUT LEADING SPACE
7437
011134 000000
003361*
7438 011135' 000000
011131
7439
011136 001000
000676
42420
MVI
A, "
7440 011137 000000
000040
7441 011140 001000
000341
42440
POP
H
7442
011141 001000
060337
42460
OUTCHR
;PRINT A SPACE AFTER THE LINE #
7443 011142' 001000
000315
42480
CALL
BUFLIN
;UNPACK THE LINE INTO BUF
7444 011143 000000
011163'
7445
011144 000000
011134
7446
011145' 001000
000041
42500
LXI
H,BUF-1
;POINT AT THE START OF THE UNPACKED CHARACTERS
7447
011146 000000
001430
7448
011147 000000
011143
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 27-1
F3
MAC
6-SEP-64 03:11
FANCY LIST,DELETE,EDIT,LLIS:
7449
011150
001000
000006
42520
MVI
8,0
;STOP ON ZERO ONLY
7450
011151
000000
000000
7451 011152 001000
000315
42540
CALL
STRLT3
ILITERALIZE THE LINE STRING
7452 011153 000000
007642°
7453 011154 000000
011146
7454 011155 001000
000315
42560
CALL
STRPRT
;PRINT OUT THE CHARACTERS
7455 011156 000000
067746
7456 011157 000000
011153
7457 011160 001000
000303
42580
JMP
LIST4
;PRINT ANOTHER LINE
7458 011161 000000
011077
7459 011162 000000
011156
7460 011163 001000
000601
42600
BUFLIN: LXI
B,BUF-1
7461 011164 000000
001430
7462 011165 000000
011161
7463 011166 001000
000026
42620
XWD
-01000,-026
,"MVI D, AROUND THE NEXT BYTE
7464 011167° 001000
000341
42640
PRIT4:
POP
H
;RESTORE POINTER TO START OF TEXT
7465 011170' 001000
000176
42660
PLOOP:
MOV
A,M
;GET A CHARACTER FROM LINE.
7466 011171 001000
000003
42680
INX
B
;ADVANCE STUFF COUNT
7467 011172' 001000
000267
42700
ORA
A
;IS IT A RESERVED WORD
7468 011173 001000
000043
42720
INX
H
;INCREMENT POINTER INTO TEXT
7469 011174 001000
000602
42740
STAX
8
;STORE A ZERO IF THE END
7470 011175' 001000
000310
42760
RZ
;ZERO, END OF LINE.
7471 011176* 001000
000362
42780
JP
PLOOP
REGULAR CHAR, JUST PRINT IT
7472 011177* 000000
011170
7473 011200* 000000
011164
7474
011201 001000
000376
42800
CPI
ELSETK
;IF ITS "ELSE" DON'T PRINT THE COLON
7475
011202' 000000
000220
7476
42820
;IN FRONT OF IT
7477
011203 001000
000314
42840
CZ
DCXBRT##
BACKUP STUFF COUNT TO ELIMINATE
7478
011204 000000
000000*
7479
011205 000000
011177
7480 011206 001000
060326
42860
SUI
127
;GET RID OF SIGN BIT AND ADD ONE
7481
011207 000000
060177
7482
011210* 001000
000345
42880
PUSH
H
;SAVE CURRRENT POSIT
7483
011211 001000
000021
42900
LXI
D,RESLST
;GET RESLST POINTER.
7484
011212 000000
000172
7485
011213 000000
011204
7486 011214 001000
000325
42920
RESRCH: PUSH
D
7487 011215' 001000
000365
42940
PUSH
PSW
;SAVE THE RESERVED WORD NUMBER
7488 011216 001000
000032
42960
RESCRI: LDAX
D
;GET CHARACTER FROM RESLST
7489
011217' 001000
000023
42980
INX
D
;BUMP RESLST POINTER
7490 011220* 001000
000267
43000
ORA
A
ITEST BITS
7491 011221' 001000
000362
43020
JP
RESCR1
NOT AT END OF RESERVED WORD YET
7492
011222' 000000
011216
7493
011223 000000
011212'
7494 011224* 001000
000361
43040
POP
PSW
7495
011225' 001000
000075
43060
DCR
A
IDECREMENT CHAR
7496
011226' 001000
000341
43080
POP
H
;POP START POINTER HERE
7497
011227 001000
000302
43100
JNZ
RESRCH
;NOT AT END OF RESLST YET.
7498
011230 000000
011214
7499
011231' 000000 011222
7500
43120
;HERE WHEN FOUND RIGHT RESERVED WORD
7501
011232' 001000 000176
43140
PRIT3: MOV
A,M
;GET A CHARACTER FROM RESERVED WORD
BASIC MCS 8080 GATES/ALLEN/DAYIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 27-2
F3
MAC
6-SEP-64 03:11
FANCY LIST,DELETE,EDIT,LLIST
7502
011233
001000
000267
43160
ORA
A
ISET CONDITION CODES
7503
011234 001000
000002
43180
STAX
B
7504 011235 001000
000372
43200
JM
PRIT4
7505
011236 000000
011167
7506 011237 000000
011230
7507 011240 001000
000603
43220
INX
B
7508
011241 001000
000043
43240
INX
H
;BUMP RESLST POINTER
7509
011242' 001000
000303
43260
JMP
PRIT3
;PRINT THE REST
7510
011243 000000
011232
7511
011244 000000
011236
7512
43280
7513
43300
THE FOLLOWING CODE IS FOR THE DELETE RANGE
7514
43320
,
COMMAND. BEFORE THE LINES ARE DELETED, OK'
7515
43340
;
IS TYPED.
7516
43360
;
7517
011245 001000
000315
43380
DELETE: CALL
SCNLIN
ISCAN LINE RANGE
7518
011246 000000
002333*
7519
011247 000000
011243
7520
011250 001000
000321
43400
POP
D
;POP MAX LINE OFF STACK
7521 011251 001000
000305
43420
PUSH
B
;SAVE POINTER TO START OF 1ST LINE
7522 011252 001000
000315
43440
CALL
FNDLIN
;FIND THE LAST LINE
7523 011253 000000
002371
7524 011254 000000
011246
7525
011255' 001000
000301
43460
POP
8
;GET POINTER TO FIRST IN [B,C]
7526 011256 001000
000345
43480
PUSH
H
;SAVE THE POINTER TO THE NEXT LINE
7527
011257 001000
000641
43500
LXI
H,REDDY
;PRINT "OK" PREMATURELY
7528 011260° 000000
001725'
7529
011261 000000
011253
7530
011262 001000
000315
43520
CALL
STROUT
7531
011263 000000
007743
7532
011264 000000
011260*
7533
011265' 001000
000041
43540
LXI
H,FINI
;GO BACK TO FINI WHEN DONE
7534
011266 000000
002276
7535
011267 000000
011263
7536
011270 001000
000343
43560
XTHL
; [H,L] =POINTER TO THE NEXT LINE
7537
011271 001000
000353
43580
DEL:
XCHG
; (D,E) NOW HAVE THE POINTER TO THE LINE
7538
43600
;BEYOND THIS ONE
7539
011272 001000
000052
43620
LHLD
VARTAB
;COMPACTIFYING TO VARTAB
7540
011273 000000
001621
7541
011274 000000
011266
7542 011275 001000
000032
43640
MLOOP:
LDAX
D
7543
011276 001000
000002
43660
STAX
B
ISHOVING DOWN TO ELIMINATE A LINE
7544
011277° 001000
000003
43680
INX
B
7545
011300° 001000
000023
43700
INX
D
7546
011301' 001000
000347
43720
COMPAR
7547
011302 001000
000322
43740
JNC
MLOOP
;DONE COMPACTIFYING?
7548
011303 000000
011275'
7549
011304 000000
011273
7550
011305 001000
000140
43760
MOV
H,B
7551
011306 001000
000151
43780
MOV
L,C
7552 011307 001000
000043
43800
INX
H
;NEW VARTAB
7553
011310 001000
000042
43820
SHLD
VARTAB
7554
011311 000000
001621
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 27-3
F3
MAC
6-SEP-64 03:11
FANCY LIST,DELETE,EDIT,LLIST
7555
011312 000000 011303
7556
011313 001000 000311
43840
RET>
7557
43860 PAGE
BASIC MCS 8080
GATES/ALLEN/DAVIDOFF
MACRO 47 (113) 03:12 10-SEP-75 PAGE 28
F3
MAC
6-SEP-64 03:11
DISK CODE
7558
43880 SUBTTL DISK CODE
7559
43900
IFN
DSKFUN, <
7560
43920
,
7561
43940
; THE STATEMENT DSKOS STRING, SECTOR WRITES
7562
43960
; THE STRING (UP TO 132 DECIMAL CHARS
7563
43980
: ON THE SECTOR SPECIFIED
7564
44000
; OSKIS (SECTOR) IS A STRING FUNCTION THAT
7565
44020
; RETURNS THE 133 BYTE STRING STORED ON SECTOR.
7566
44040
;
7567
44060
DSKOS: CALL
FRMEVL
;EVALUATE FORMULA
7568
44080
SYNCHK
44
;FOLLOWED BY COMMA
7569
44100
PUSH
H
;SAVE TEXT POINTER
7570
44120
CALL
FRESTR
;FREE UP THE FACLO
7571
44140
XTHL
; H,L1=TXTPTR SAVE POINTER AT
7572
44160
;STRING DESCRIPTOR ON THE STACK
7573
44180
CALL
GETBYT
EVALUATE 2ND (SECTOR) IN (E)
7574
44200
XTHL
SAVE TEXT POINTER, GET DESC.
7575
44220
PUSHM
; (C) =LENGTH (H, =POINTER
7576
44240
PUSHM
7577
44260
POP
H
; [H,L] GET STRING POINTER
7578
44280
POP
B
7579
44300
MOV
B,A
; SECTOR NUMBER INTO [B]
7580
44320
MVI
A, 0137
7581
44340
SUB
C
7582
44360
JC
FCERR
; STRING TOO LONG
7583
44380
INR
A
7584
44400
MOV
E,A
;NUMBER OF ZEROS+1
7585
44420
MVI
0,64
;SETUP A MASK
7586
44440
INR
C
7587
44460
MVI
A,4
,LOAD THE HEAD
7588
44480
OUT
9
;TO DISK STATUS
7589
44500
SECLP:
IN
011
;GET SECTOR STATUS
7590
44520
RAR
ITEST FOR START OF SECTOR
7591
44540
JNC
SECLP
IKEEP WAITING
7592
44560
ANI
63
;START OF SECTOR, RIGHT ONE
7593
44580
CMP
B
;COMPARE TO FIND OUT
7594
44600
JNZ
SECLP
IIF NOT
7595
44620
MVI
A,128
;WRITE ENABLE DISK
7596
44640
OUT
9
7597
44660
MVI
8,255
FALL ONE'S ALWAYS WRITTEN FIRST
7598
44680
WRITOK: IN
8
;GET STATUS
7599
44700
ANA
D
;WRITE OK
7600
44720
JZ
WRITOK
;NO, MORE LOOPING.
7601
44740
MOV
A,B
;GET CHARACTER TO WRITE
7602
44760
OUT
10
;SEND IT OUT
7603
44780
DCR
C
;TEST FOR NULL
7604
44800
JZ
ZRLOP
7605
44820
NOTYTD:
IN
8
;POLL
7606
44840
ANA
D
;MASK TEST
7607
44860
JZ
NOTYTD
;WAITING
7608
44880
MOV
A,M
;GET CHARACTER
7609
44900
OUT
10
7610
44920
DCR
C
;DECREMENT CHARACTER COUNT
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47 (113) 03:12 10-SEP-75 PAGE 28-1
F3
MAC
6-SEP-64 03:11
DISK CODE
7611
44940
INX
H
7612
44960
JNZ
NOTYTO
7613
44980
ZRLOP:
IN
8
7614
45000
ANA
D
7615
45020
JZ
ZRLOP
7616
45040
XRA
A
;PUT OUT A ZERO
7617
45060
OUT
10
7618
45080
DCR
E
7619
45100
JNZ
ZRLOP
7620
45120
TRUFIN: MVI
A,8
;UNLOAD THE HEAD
7621
45140
OUT
9
7622
45160
POP
H
7623
45180
RET
IDONE
7624
45200
7625
45220
DSKIS:
MVI
A,137
;A LOT OF CHARACTERS ARE COMING
7626
45240
CALL
STRINI
;MAKE ROOM!
7627
45260
CALL
CONINT
;WHERE ARE THEY?
7628
45280
;SECTOR NOW IN (E)
7629
45300
LHLD
DSCTMP+2
;PLACE TO STORE THEM
7630
45320
MVI
A,4
;LOAD THE HEAD
7631
45340
OUT
9
7632
45360
SECLP2:
IN
9
;GET SECTOR INFO
7633
45380
ORA
A
;SEE IF BEGINNING OF SECTOR(READ)
7634
45400
JP
SECLP2
IF NOT, KEEP WAITING
7635
45420
RAR
;FIX UP SECTOR #
7636
45440
ANI
63
;GET SECTOR #
7637
45460
CMP
E
;IS IT THE ONE WE WANTED
7638
45480
JNZ
SECLP2
;TRY TO FIND IT
7639
45500
MVI
C,137
;GET # OF CHARS TO READ
7640
45520
READOK: IN
8
;GET DISK STATUS
7641
45540
ORA
A
READY TO READ BYTE
7642
45560
JP
READOK
7643
45580
IN
10
;READ THE STUFF
7644
45600
MOV
M,
;SAVE IN STR
7645
45620
INX
H
;BUMP DEST POINTER
7646
45640
DCR
C
,LESS CHARS
7647
45660
JNZ
READOK
7648
45680
MVI
A,8
;UNLOAD HEAD
7649
45700
OUT
9
7650
45720
JMP
FINBCK
;USE CHRS TO FINISH UP
7651
45740
7652
45760
PATCH:
BLOCK
20>
7653
45780
PAGE