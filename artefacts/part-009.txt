
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 12-1
F3
MAC
6-SEP-64 03:11
RESTORE,STOP,END,LINGET,CHRCON
3035 003520 000000 003514
3036 003521' 001000 000042
44160
SHLD
OLDTXT
;SAVE IT
3037 003522' 000000 001613
3038
003523
000000
003517
3039
003524
44180
DIRIS:
3040
44200
IFN
CONTRW
3041
003524 001000
000257
44220
XRA
A
3042
003525
001000
000062
44240
STA
CNTWFL>
;FORCE OUTPUT
3043 003526' 000000
001541
3044
003527° 000000
003522'
3045 003530 001000
000361
44280
POP
PSW
;GET BACK °C FLAG
3046 003531 001000
000041
44300
LXI
,BRKTXT
" "RREAK"
3047 003532' 000000
001734
3048 003533 000000
003526
3049 003534* 001000
000302
44320
JNZ
ERRFIN
;CALL STROUT AND FALL INTO READY
3050
003535'
000000
002127
3051
003536 000000
003532'
3052
003537
001000
000303
44340
JMP
READY>
;TYPE "READY"
3053
003546
000000
002145'
3054
003541
000000
003535'
3055
44360
IFE
REALIO,<
3056
44380
ODT:
POP
8
;GET RID OF NEWSTT RETURN
3057
44400
HRRZ
14,JOBDDT##
3058
44420
JRST
0(14)>
3059
3060
44460
IFN
LENGTH,
3061 003542' 001000 000300
44480
CONT:
RNZ
;MAKE SURE THERE IS A TERMINATOR
3062 003543 001000 000036
44500
MVI
E,ERRCN
3063 003544 000000 000021
3064 003545 001000 000052
44520
LHLD
OLDTXT
iA STORED TEXT POINTER OF
3065 003546 000000 001613
3066
003547°
000000
003540
3067
44540
;ZERO IS SETUP BY STKINI
3068
44560
;AND INDICATES THERE IS NOTHING
3069
44580
ITO CONTINUE
3070
003550
001000
000174
44600
MOV
A,H
""STOP", "END", TYPING CRLF
3071
003551
001000
060265
44620
ORA
L
;TO "INPUT" AND "C SETUP OLDTXT
3072
003552'
001000
000312
44640
JZ
ERROR
3073 003553 000000
002102'
3074 003554 000000
003546
3075 003555' 001000
000353
44660
XCHG
;SAVE (H.L)
3076 003556 001000
000052
44680
LHLD
OLDLIN
3077 003557 000000
001611
3078 003560 000000
003553'
3079
003561 001000
000042
44700
SHLD
CURLIN
;SET UP OLD LINE # AS CURRENT LINE #
3080 003562 000000
001607
3081 003563 000000
003557
3082 003564 001000
000353
44720
XCHG
IRESTORE [H,L]
3083 003565 001000
000311
44740
RET>
3084
44760
IFN
LENGTH,
3085 0035661 001000 000315
44780
NULL:
CALL
GETBYT
3086 003567 000000 011020
3087 003570 000000 003562'
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 12-2
F3
MAC
6-SEP-64 03:11
RESTORE,STOP,END,LINGET,CHRCON
3088 003571 001000 000300
44800
RNZ
;MAKE SURE THERE IS A TERMINATOR
3089
003572
001000
000674
44820
INR
A
3090
003573
001000
000376
44840
CPI
LINLEN
;MAKE SURE THE NUMBER IS REASONABLE
3091
003574
000000
000110
3092
44860
;CRDO WON'T WORK IF IT ISN'T
3093
003574
44880
LINPT2==:,
TERMINAL WIDTH CHANGE LOCATION
3094
003575
001000
000322
44900
JNC
FCERR
;"FUNCTION CALL" ERROR
3095 003576 000000
010776
3096
003577
000000
003567
3097 003600 001000
000062
44920
STA
NULCNT
;CHANGE NUMBER OF NULLS
3098 003601 000000
000046
3099 003602' 000000
003576
3100
003603 001000
000311
44940
RET>
3101
44960
IFE
LENGTH-2,
3102
003604 001000
000076
44980
TON:
XWD
01000,006
;"MVI A, NON-ZERO QUANTITY
3103 003605 001000
000257
45000
TOFF:
XRA
A
;MAKE (A) # FOR NO TRACE
3104 003606 001000
000062
45020
STA
TRCFLG
;UPDATE THE TRACE FLAG
3105 003607 000000 001631
3106
003610
000000
003601
3107
003611
001000
000311
45040
RET>
3108
45060
;
3109
45080
;TEST FOR A LETTER / CARRY ON=NOT A LETTER
3110
45100
CARRY OFF=A LETTER
3111
45120
3112
003612'
001000
000176
45140
ISLET:
MOV
A,M
3113
003613
001000
000376
45160
CPI
"A"
3114 003614 000000
000101
3115 003615* 001000
000330
45180
RC
;IF LESS THAN "A", RETURN EARLY
3116 003616 001000 000376
45200
CPI
91
191="Z"+1
3117 003617 000000 000133
3118 003620 001000 000077
45220
CMC
3119
003621 001000 000311
45240
RET
3120
45260
3121
45280
INTIOX READS A FORMULA FROM THE CURRENT POSITION AND
3122
45300
TURNS IT INTO A POSITIVE INTEGER
3123
45320
LEAVING THE RESULT IN (D,E), NEGATIVE ARGUMENTS
3124
45340
; ARE NOT ALLOWED. [H,L] POINTS TO THE TERMINATING
3125
45360
; CHARACTER OF THE FORMULA ON RETURN.
3126
45380
;
3127
45400
IFN
LENGTH-2,
3128
45420
INTIOX: CHRGET
3129
45440
INTID2: CALL
FRMNUM
3130
45460
POSINT: FSIGN
3131
45480
JM
FCERR
;IF NEGATIVE BLOW HIM OUT
3132
45500
DEINT:
LDA
FAC
ISEE IF ARG GREATER THAN 32767
3133
45520
CPI
144
3134
45540
JC
QINT
3135
45560
IFN
LENGTH,
3136
45580
MOVRI
144,128,0,0
REGISTERS # FLOATING -32768
3137
45600
CALL
FCOMP
;SEE IF FAC=REGISTERS
3138
45620
MOV
D,C
;SETUP D=200 E=0 FOR -32768
3139
45640
RZ>
,WAS -32768. [D,E] IS SET UP
3140
45660
ILLFUN:
BASIC MCS 8080 GATES/ALLEN/DAVIDO
MACRO 47(113) 03:12 10-SEP-75 PAGE 12-3
F3
MAC
6-SEP-64 03:11
RESTORE, STOP,END,LINGET,CHRCON
3141
45680
FCERR:
MVI
E,RRFC
;TOO BIG. FUNCTION CALL ERROR
3142
45700
JMP
ERROR>
3143
45720
IFE
LENGTH-2,<
3144
003622' 001000
000327
45740
INTIOX: CHRGET
3145 003623 001000
000315
45760
INTID2: CALL
FRMEVL
EVALUATE A FORMULA
-
3146
003624 000000
005336
3147
003625 000000
003607
3148 003626 001000
000345
45780
PUSH
H
;SAVE THE TEXT POINTER
-
3149 003627 001000
000315
45800
CALL
FRCINT
;CONVERT THE FAC TO AN INTEGER
3150 003630 000000
000666*
3151 003631 000000
003624
-
3152 003632' 001000
000174
45820
MOV
A,H
;SEE IF THE RESULT IS NEGATIVE
3153 003633 001000
000267
45840
ORA
A
IBY LOOKING AT [H]'S MSB
3154 003634 001000
060372
45860
JM
FCERR
;DON'T ALLOW NEGATIVE NUMBERS
-
3155 003635' 000000
010776
3156
003636 000000
003630
3157 003637 001000
000353
45880
XCHG
RETURN THE INTEGER IN (D,E)
3158
003640 001000
000341
45900
POP
H
IRESTORE THE TEXT POINTER
3159
003641 001000
000311
45920
RET>
3160
3161
45960
3162
45980
LINGET READS A LINE # FROM THE CURRENT TEXT POSITION
3163
46000
3164
46020
LINE NUMBERS RANGE FROM 0 TO 65529
3165
46040
3166
46060
(D,E) IS SMASHED.
3167
46080
3168
46100
ANSWER RETURNED IN [D,E],
3169
46120
(H,L) IS UPDATED TO POINT TO THE TERMINATING CHARACTER
3170
46140
AND [A] CONTAINS THE TERMINATING CHARACTER WITH CONDITION
3171
46160
,
CODES SET UP TO REFLECT ITS VALUE,
3172
46180
;
3173 003642 001000
000053
46200
LINGET: DCX
H
3174 003643 001000
000021
46220
LINGT2: LXI
,SCODE
;ZERO ACCUMULATED LINE
3175 003644 000000
000000
3176 003645 000000
003635
3177 003646 001000
000327
46240
MORLIN: CHRGET
3178 003647 001000
000320
46260
RNC
;WAS IT A DIGIT
3179 003650 001000
000345
46280
PUSH
H
3180 003651 001000
000365
46300
PUSH
PSW
3181 003652 001000
000641
46320
LXI
SCODE+6552
;SEE IF THE LINE # IS TOO BIG
3182 003653 000000
014630
3183 003654 000000
003644
3184 003655 001000
000347
46340
COMPAR
3185 003656 001000
000332
46360
JC
SNERR
IYES, SYNTAX ERROR
3186 003657 000000
002072'
3187 003660 000000
003653
3188 003661 001000
000142
46380
MOV
H,D
;SAVE (D,E)
3189 003662' 001000
000153
46400
MOV
L,E
3190 003663 001000
000031
46420
DAD
D
3191 003664 001000
000051
46440
DAD
H
3192 003665' 001000
000031
46460
DAD
D
3193
003666° 001000
000051
46480
DAD
H
;PUTTING (0,E)*10 INTO [H,L]
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 12-4
F3
MAC
6-SEP-64 03:11
RESTORE,STOP,END,LINGET,CHRCON
3194 003667 001000 000361
46500
POP
PSW
3195
003670
001000
000326
46520
SUI
"0"
3196
003671
000000
000060
3197 003672' 001000
000137
46540
MOV
E,A
3198
003673
001000
000026
46560
MVI
0,0
3199 003674 000000
000000
3200 003675 001000
000031
46580
DAD
D
PADD THE NEW DIGIT
3201 003676 001000
060353
46600
XCHG
3202 003677 001000
000341
46620
POP
H
;GET BACK TEXT POINTER
3203 003700 001000
000303
46640
JMP
MORLIN
3204
003701 000000
003646
3205 003702' 000000
003657
3206
46660
IFN
LENGTH, <
3207 003703 001000
000312
46680
CLEAR:
JZ
CLEARC
IIF NO FORMULA JUST CLEAR
3208 003704 000000
002443
3209 003705 000000
003701
3210 003706 001000
060315
46700
CALL
INTID2
;GET AN INTEGER INTO CD,E
3211 003707 000000
003623
3212 003710 000000
003704
3213 003711 001000
000053
46720
DCX
H
3214 003712 001000
000327
46740
CHRGET
;SEE IF ITS THE END
3215 003713 001000
000300
46760
RNZ
;SHOULD FINISH THERE
3216 003714 001000
000345
46780
PUSH
H
;SAVE TXTPTR
3217 003715' 001000
000052
46800
LHLD
MEMSIZ
;GET HIGHEST ADDRESS
3218 003716 000000
001545
3219 003717 000000
003707
3220 003720 001000
000175
46820
MOV
A,L
;SUBTRACT [H,L]-[0,E] INTO (D,E)
3221 003721 001000
000223
46840
SUB
E
3222 003722 001000
000137
46860
MOV
E,A
3223 003723 001000
000174
46880
MOV
A,H
3224 003724 001000
000232
46900
SBB
D
3225 003725' 001000
000127
46920
MOV
D,A
3226 003726 001000
000332
46940
JC
SNERR
;WANTED MORE THAN TOTAL:
3227 003727 000000
002672
3228 003730 000000
003716
3229 003731 001000
000052
46960
LHLD
VARTAB
;TOP LOCATION IN USE
3230 003732 000000
001621
3231 003733 000000
003727
3232 003734 001000
000001
46980
LXI
B,SCODE+40
;LEAVE BREATHING ROOM
3233 003735 000000
000050
3234 003736 000000
003732
3235 003737 001000
000011
47000
DAD
8
3236 003746 001000
000347
47020
COMPAR
FROOM?
3237 003741 001000
000322
47040
JNC
OMERR
INO, DON'T EVEN CLEAR
3238 003742 000000
002057
3239 003743 000000
003735'
3240 003744 001000
000353
47060
XCHG
;NEW STACK LOCATION (H,L)
3241 003745 001000
000042
47080
SHLD
STKTOP
ISET UP NEW STACK LOCATION
3242 003746 000000
001615
3243 003747 000000
003742'
3244 003750 001000
000341
47100
POP
H
IREGAIN THE TEXT POINTER
3245
003751 001000
000303
47120
JMP
CLEARC>
;GO CLEAR
3246
003752' 000000
002443
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 12-5
F3
MAC
6-SEP-64 03:11
RESTORE,STOP,END,LINGET,CHRCON
3247 003753 000000 003746
3248
47140 PAGE
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 13
F3
MAC
6-SEP-64 03:11
RUN,GOTO,GOSUB,RETURN
3249
47160
SUBTTL RUN,GOTO,GOSUB, RETURN
3250
47180
IFN
LENGTH,<
3251
003754 001000
060312
47200
RUN:
JZ
RUNC
INO LINE # ARGUMENT
3252
003755' 000000 002437
3253
003756 000000
003752'
3254
47220
;CLEAN UP,SET [H,L] =[TXTTAB]- AND
3255
47240
IRETURN TO NEWSTT
3256
003757 001000 000315
47260
CALL
CLEARC
;CLEAN UP -- RESET THE STACK
3257
003760 000000 002443
3258 003761 000000 003755'
3259
47280
1 DATPTR, VARIABLES
3260
47300
; (H,L) IS THE ONLY THING PRESERVED
3261
003762 001000
000001
47320
LXI
B,NEWSTT
3262 003763 000000 003302'
3263 003764 000000 003760
3264 003765 001000 000303
47340
JMP
RUNC2>
;PUT "NEWSTT" ON AND FALL INTO "GOTO"
3265
003766 000000
004007
3266
003767 000000
003763
3267
47360
3268
47380
A GOSUB ENTRY ON THE STACK HAS THE FOLLOWING FORMAT
3269
47400
3270
47420
LOW ADDRESS
3271
47440
3272
47460
A TOKEN EQUAL TO GOSUTK 1 BYTE
3273
47480
THE LINE # OF THE THE GOSUB STATEMENT 2 BYTES
3274
47500
A POINTER INTO THE TEXT OF THE GOSUB 2 BYTES
3275
47520
3276
47540
HIGH ADDRESS
3277
47560
3278
47580
;
TOTAL 5 BYTES
3279
47600
;
3280
003770 001000
000315
47620
GOSUB: CALL
GETSTK
;MAKE SURE THERE IS ROOM
3281
003771 000000
002624
3282
003772
000000
003766
3283 003773 000000
000003
47640
3
3284 003774 001000
000301
47660
POP
8
;POP OFF RETURN ADDRESS OF "NEWSTT"
3285 003775 001000
000345
47680
PUSH
H
REALLY PUSH THE TEXT POINTER
3286 003776 001000
000345
47700
PUSH
H
;SAVE TEXT POINTER
3287 003777 001000
000052
47720
LHLD
CURLIN
;GET THE CURRENT LINE
#
3288 004000 000000
001607
3289 004001 000000
003771
3290 004002' 001000
000343
47740
XTHL
;PUT CURLIN ON THE STACK AND H,L]=TEXT PTR
3291
004003 001000
000026
47760
MVI
D,GOSUTK
,LEAVE A GOSUB TOKEN
3292
004004 000000
000214
3293
47780
ION THE STACK
3294
004005 001000
000325
47800
PUSH
D
3295
004006 001000 000063
47820
INX
SP
;THE GOSUB TOKEN TAKES ONLY ONE BYTE
3296
004007 001000 000305
47840
RUNC2:
PUSH
8
;RESTORE RETURN ADDRESS
3297
47860
OF "NEWSTT"
3298
47880
;
3299
47900
;
IN THE 4K VERSION WE START AT THE BEGINNING
3300
47920
;
AND SEARCH. IN THE 8K WE START WHERE WE
3301
47940
:
ARE IF WE ARE GOING TO A FORWARD LOCATION.
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO /(113) 03:12 10-SEP-75 PAGE 13-1
F3
MAC
6-SEP-64 03:11
GOTO, GOSUB, RETURN
3302
47960 ;
3303
004010 001000 000315
47980
GOTO:
CALL
LINGET
;PICK UP THE LINE
3304
004011 000000 003642
3305
004012' 000000 004000
3306
48000
;AND PUT IT IN (D,E)
3307
48020
IFE
LENGTH, <RNZ
;SHOULD END WITH A LINE
3308
48040
;TERMINATOR -- BLOW HIM UP
3309
48060
;IF IT DOESN'T
3310
48080
(ON GOTO MAKES THIS WRONG
3311
48100
;IN OTHER VERSONS)
3312
48120
CALL
FNDLIN>
3313
48140
IFN
LENGTH,
3314 004013 001000 000315
48160
CALL
REM
ISKIP TO THE END OF THIS LINE
3315 004014 000000 004074
3316 004015' 000000 004011
3317 004016* 001000 000345
48180
PUSH
H
;SAVE THE POINTER
3318 004017 001000 000052
48200
LHLO
CURLIN
;GET THE CURRENT LINE #
3319 004020 000000 001607
3320 004021 000000 004014*
3321 004022' 001000 000347
48220
COMPAR
(D,E) CONTAINS WHERE WE ARE GOING
.
3322
48240
; [H,L] CONTAINS THE CURRENT LINE#
3323
48260
ISO COMPARING THEM TELL US WHETHER TO
3324
48280
1START SEARCHING FROM WHERE WE ARE OR
-
3325
48300
ITO START SEARCHING FROM THE BEGINNING
3326
48320
10F TXTTAB
3327
004023
001000
000341
48340
POP
H
; [H,L: =CURRENT POINTER
-
3328
004024
001000
000043
48360
INX
H
;POINT AT THE LINK BEYOND IT
3329 004025' 001000 000334
48380
CC
LOOP
;SEARCH FROM THIS POINT
3330 004026 000000 002374
.
3331
004027
000000
004020
3332 004030* 001000 000324
48400
CNC
FNOLIN>
;SEARCH FROM THE BEGINNING -- ACTUALLY
3333
004031
000000
002371
-
3334
004032'
000000
004026
3335
48420
;SEARCH AGAIN IF ABOVE SEARCH FAILED
3336
004033°
001000
000140
48440
MOV
H,B
-
3337
004034
001000
000151
48460
MOV
L,C
3338 004035' 001000
000053
48480
DCX
H
3339 004036 001000
000330
48500
RC
IIF A MATCH WE ARE DONE
3340 004037 001000 000036
48520
USERR:
MVI
E,ERRUS
3341
004040 000000
000010
3342 004041 001000 000303
48540
JMP
ERROR
;C=MATCH, so IF NO MATCH WE
3343 004042 000000 002102'
3344
004043 000000
004031
3345
48560
;GIVE A "US" ERROR
3346
48580
3347
48600
SEE "GOSUB" FOR THE FORMAT OF THE STACK ENTRY
3348
48620
"RETURN" RESTORES THE LINE NUMBER AND TEXT POINTER ON THE STACK
3349
48640
AFTER ELIMINATING ALL THE "FOR" ENTRIES IN FRONT OF THE "GOSUB"
3350
48660
ENTRY
3351
48680
;
3352 004044 001000 000300
48700
RETURN: RNZ
BLOW HIM UP IF THERE ISN'T A TERMINATOR
3353 004045 001000 000026
48720
MVI
0,255
;MAKE SURE THIS VARIABLE POINTER
3354 004046 000000 000377
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 13-2
F3
MAC
6-SEP-64 03:11
GOTO, GOSUB, RETURN
3355
48740
;IN (D,E) NEVER GETS MATCHED
3356
004047
001000
000315
48760
CALL
FNDFOR
IGO PAST ALL THE "FOR" ENTRIES
3357
004050
000000
001744
3358 004051 000000 004042
3359 004052' 001000 000371
48780
SPHL
;UPDATE THE STACK
3360 004053 001000
000376
48800
CPI
GOSUTK
3361 004054 000000
000214
3362 004055 001000
000036
48820
MVI
E,ERRRG
;ERROR ERRRG IS "RETURN WITHOUT GOSUB"
3363 004056 000000
000003
3364 004057 001000
000302
48840
JNZ
ERROR
3365 004060 000000
002102'
3366 004061 000000
004050
3367 004062' 001000
060341
48860
POP
H
;GET LINE # "GOSUB" WAS FROM
3368
004063 001000
000042
48880
SHLD
CURLIN
PUT IT INTO CURLIN
3369 004064 000000
001607
3370 004065' 000000
004060
3371
004066 001000
000041
48900
LXI
H,NEWSTT
3372
004067 000000
003302
3373
004070 000000 004064
3374
004071 001000 000343
48920
XTHL
;PUT RETURN ADDRESS OF "NEWSTT"
3375
48940
BACK ONTO THE STACK. GET TEXT POINTER
3376
48960
;FROM "GOSUB"
3377
48980
;SKIP OVER SOME CHARACTERS
3378
49000
;SINCE WHEN "GOSUB" STUCK THE TEXT POINTER
3379
49020
IONTO THE STACK THE LINE # ARGUMENT HADN'T
3380
49040
;BEEN READ IN YET.
3381
3382
3383
49100
IFN
STRING,
3384
004072 001000 000001
49120
DATA:
XWD
01000,001
;"LXI B," TO PICK UP ":" INTO C AND SKIP
3385
004073 000000 000072
49140
":"
;"DATA" TERMINATES ON ":"
3386
49160
BAND 0. ":" ONLY APPLIES IF
3387
49180
;QUOTES HAVE MATCHED UP
3388
004074
49200
IFE
LENGTH-2, <ELSE:>
;EXECUTED "ELSE"S ARE SKIPPED
3389
49220
;
3390
49240
;
NOTE: REM MUST PRESERVE (D,E) BECAUSE OF "GO TO" AND ERROR
3391
49260
;
3392
004074 001000
000016
49280
REM:
XWD
01000, -016
IMVI C, THE ONLY TERMINATOR IS 0
3393 004075 001000 000000
49300
XWD
01000.0
INO-OPERATION
3394
49320
;"DATA" ACTUALLY EXECUTES THIS 0
3395 004076 001000 000006
49340
MVI
8,0
;INSIDE QUOTES THE ONLY TERMINATOR IS ZERO
3396 004077° 000000 000000
3397 004100 001000 000171
49360
EXCHQT: MOV
A,C
;WHEN A QUOTE IS SEEN THE SECOND
3398 004101 001000
000110
49380
MOV
C,B
TERMINATOR IS TRADED, so IN "DATA"
3399 004102' 001000
000107
49400
MOV
8,A
;COLONS INSIDE QUOTATIONS WILL HAVE NO EFFECT
3400 004103 001000
000176
49420
REMER:
MOV
A,M
IGET THE CHARACTER
3401 004104 001000
000267
49440
ORA
A
;ZERO IS ALWAYS A TERMINATOR
3402 004105 001000
000310
49460
RZ
3403 004106' 001000
060270
49480
CMP
8
;TEST FOR THE OTHER TERMINATOR
3404 004107 001000
000310
49500
RZ
3405 004110 001000
000043
49520
INX
H
3406 004111 001000 000376
49540
CPI
34
;IS IT A QUOTE?
3407 004112' 000000 000042