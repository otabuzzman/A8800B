
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47 (113) 03:12 10-SEP-75 PAGE 13-3
F3
MAC
6-SEP-64 03:11
RUN, GOTO, GOSUB, RETURN
3408 004113 001000 000312
49560
JZ
EXCHQT
;IF so TIME TO TRADE
3409 004114 000000 004100
-
3410
004115' 000000 004067
3411
49580
IFE
LENGTH-2,<
3412
49600
3413
49620
i WHEN AN "IF" TAKES A FALSE BRANCH IT MUST FIND THE APPROPRIATE "ELSE"
3414
49640
;
TO START EXECUTION AT. "DATA" COUNTS THE NUMBER OF "IF"S
3415
49660
;
IT SEES so THAT THE "ELSE" CODE CAN MATCH "ELSE"S WITH
3416
49680
"IF"S. THE COUNT IS KEPT IN [D]
3417
49700
3418 004116 001000 000326
49720
SUI
I TK
;IS IT AN "IF"
3419 004117° 000000 000212
3420 004120 001000 000302
49740
JNZ
REMER
;IF NOT, CONTINUE ON
3421 004121 000000 004103
-
3422 004122' 000000 004114
3423
004123
001000
000270
49760
CMP
B
;SINCE "REM" CAN'T SMASH
3424
49780
; (D,E) WE HAVE TO BE CAREFUL
3425
49800
ISO ONLY IF B DOESN'T EQUAL
3426
49820
IZERO WE INCREMENT D. (THE "IF" COUNT)
3427
004124 001000 000212
49840
ADC
D
;CARRY ON IF [B] NOT ZERO
.
3428
004125' 001000 000127
49860
MOV
D,A>
UPDATE [D]
3429
004126 001000 000303
49880
JMP
REMER>
3430
004127' 000000 004103
-
3431
004130 000000 004121'
3432
49900
3433
49902
WITHOUT STRINGS THERE IS NO NEED TO WATCH QUOTATIONS
-
3434
49904
;
so [B] IS SET UP AS THE SECONDARY TERMINATOR
3435
49906
;
AND A SCAN IS MADE FOR (B) OR ZERO
3436
49908
;
.
3437
49920
IFE
STRING,
<
3438
49940
DATA:
XWD
01000,1
;MAKE (C) AND SKIP
3439
49960
":"
-
3440
49980
REM:
XWD
01000,16
;MAKE (C)=0
3441
50000
XWD
01000.00
IZERO AND NO-OPERATION
3442
50020
LOOPDR:
MOV
A,M
-
3443
50040
ORA
A
IALWAYS STOP ON ZERO
3444
50060
RZ
3445
50080
CMP
e
CHECK FOR ":" IN DATA
3446
50100
RZ
3447
50120
INX
H
;LOOK AT NEXT CHARACTER
3448
50140
JMP
LOOPDR>
3449
50160
PAGE
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 14
F3
MAC
6-SEP-64 03:11
"LET"
3450
50180 SUBTIL "LET"
3451 004131 001000 000315
50200
LET:
CALL
PIRGET
;GET THE POINTER TO THE VARIABLE
3452
004132' 000000 006505'
3453
004133° 000000 004127
3454
50220
;NAMED IN TEXT AND PUT
.
3455
50240
IIT ON THE STACK. (H,L) REMAINS
3456
50260
;THE TEXT POINTER AND A, PSW ARE SETUP
3457
50280
;AS THE TERMINATING CHARACTER,
3458
004134
001000
000317
50300
SYNCHK EQULTK
;CHECK FOR "="
3459
004135' 000000 000260
3460
004136
50320
REDINP:
3461
50340
IFN
STRING,
3462
004136 001000
000072
50360
LDA
VALTYP
3463 004137 000000
001543
.
3464 004140 000000
004132'
3465 004141 001000
000365
50380
PUSH
PSW>
3466 004142' 001000
000325
50400
PUSH
D
3467 004143 001000
000315
50420
CALL
FRMEVL
;GET THE VALUE OF THE FORMULA
3468
004144 000000
005336
3469
004145 000000
004137
3470
50440
;INTO FAC
3471
004146 001000
000343
50460
XTHL
; (H,L) =POINTER TO VARIABLE
3472
50480
;TEXT POINTER TO ON TOP OF STACK
3473
004147 001000
000042
50500
SHLD
TEMP
;SAVE VARIABLE POINTER FOR "FOR"
3474
004150 000000
001603
3475
004151 000000
004144
3476
50520
IFN
STRING,
3477
004152' 001000
000321
50540
POP
D
;GET TEXT POINTER OFF
3478
004153' 001000
000361
50560
POP
PSW
;GET THE VALTYP OF THE
.
3479
50580
;VARIABLE INTO (A)
3480
004154
001000
000325
50581
PUSH
D
IRESAVE THE TEXT-POINTER
3481
50582
IFE
LENGTH-2,
-
3482
004155 001000
000376
50584
CPI
3
;SEE IF ITS A STRING
3483 004156 000000
000003
3484 004157 001000
000345
50586
INPCOM: PUSH
H
;SAVE THE POINTER AT THE VALUE POSITION
.
3485 004160 001000
000302
50588
JNZ
COPNUM
INUMERIC, so FORCE IT AND COPY
3486 004161 000000
004237
3487 004162 000000
004150
3488
004163 001000
000315
50590
CALL
CHKSTR>
;MAKE SURE THE FORMULA WAS A STRING
3489
004164
000000
000000*
3490
004165'
000000
004161
3491
50600
IFN
LENGTH-2,
3492
50620
RAR
;CARRY SET FOR STRING OFF
3493
50640
FFOR NUMERIC
3494
50660
CALL
CHKVAL
;MAKE SURE VALTYP MATCHES CARRY
3495
50680
;AND SET THE ZERO FLAG
3496
50700
ION A NUMERIC VALTYP
3497
50860
JZ
COPNUM
;IF A NUMBER COPY
3498
50880
INPCOM: PUSH
H>
1SAVE POINTER AT VARIABLE
3499 004166 001000 000052
50900
LHLD
FACLO
;GET POINTER TO THE DESCRIPTOR OF THE RESULT
3500 004167 000000 001637
3501 004170 000000 004164
3502 004171 001000 000345
50920
PUSH
H
;SAVE THE POINTER AT THE DESCRIPTOR
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47 (113) 03:12 10-SEP-75 PAGE 14-1
F3
MAC
6-SEP-64 03:11
"LET"
3503
004172'
001000
000043
50940
INX
H
3504
004175
001000
000043
50960
INX
H
3505
004174
001000
000367
50980
PUSHM
3506
004175
001000
000321
51000
POP
D
3507 004176 001000
000052
51020
LHLD
STKTOP
;SEE IF IT POINTS INTO STRING SPACE
3508
004177
000000
001615
3509 004200 000000
004167
3510
004201 001000
000347
51040
COMPAR
;IF NOT DON'T COPY
3511 004202 001000
000321
51060
POP
D
;GET BACK THE POINTER AT THE DESCRIPTOR
3512 004203 001000
000322
51080
JNC
DNTCPY
IDON'T COPY LITERALS
3513 004204 000000
004217
3514
004205 000000
004177°
3515 004206 001000
000052
51100
LHLD
VARTAB
;NOW, SEE IF ITS A VARIABLE
3516 004207 000000
001621'
3517 004210 000000
004204
3518
004211 001000
000347
51120
COMPAR
IBY SEEING IF THE DESCRIPTOR
3519 004212' 001000
000153
51140
MOV
L,E
3520 004213 001000
060142
51160
MOV
H,O
3521 004214 001000
000334
51180
CC
STROPY
;IS BEYOND [VARTAB], IF so COPY
3522 004215' 000000
007601
-
3523
004216 000000
004207
3524
004217 001000
000632
51200
DNTCPY: LDAX
D
;GET THE LENGTH AND SAVE IT
3525
004220
001000
000365
51220
PUSH
PSW
;SINCE WE ARE GOING TO SET IT TO
3526
51240
10 so FRETMP DOESN'T UPDATE FRETOP
3527
004221
001000
000257
51260
XRA
A
ISET IT TO 0 -- ELIMINATING NULL
3528
51280
1STRING IN FRETMP IS HARMLESS
3529
004222'
001000
000022
51300
STAX
D
PUT 0 IN THE LENGTH FIELD
3530
004223 001000
000315
51320
CALL
FRETMP
;FREE IT UP
3531
004224 000000
010440
3532
004225 000000
004215
3533
004226 001000
000361
51340
POP
PSW
;GET LENGTH BACK
3534
004227 001000
000167
51360
MOV
M,A
;REPLACE IT ( FRETMP RETURNS (D,E) IN CH,L)
)
3535
004230
001000
000353
51380
XCHG
;PUT THE DESCRIPTOR POINTER BACK IN (D,E)
3536
004231
001000
000341
51400
POP
H
IGET THE PLACE OF THE NEW VARIABLE
3537
51420
IFN
LENGTH-2,<
3538
51440
CALL
MOVE>
;COPY THE DESCRIPTOR
3539
51460
IFE
LENGTH-2,
3540 004232 001000 000315
51480
CALL
VMOVE>
3541
004233 000000 000000*
3542
004234 000000
004224
3543
004235 001000 000341
51500
POP
H
IGET THE TEXT POINTER BACK
3544 004236 001000 000311
51520
RET>
3545
004237
51540
COPNUM:
3546
51560
IFE
LENGTH-2,
3547
004237
001000
000346
51580
ANI
6
;SETUP DISPATCH TO FORCE
3548
004240 000000 000006
3549
51600
;FORMULA TYPE TO CONFORM
3550
51620
ITO THE VARIABLE ITS BEING ASSIGNED TO
3551
004241 001000
000041
51640
LXI
1,FRCTBL
;TABLE OF FORCE ROUTINES
3552 004242 000000 000664°
3553
004243 000000 004233'
3554
004244 001000 000117
51660
MOV
C,A
(8,C) #TWO BYTE OFFSET
3555
004245 001000
000006
51680
MVI
8,0
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 14-2
F3
MAC
6-SEP-64 03:11
"LET"
3556
004246
000000
000000
3557 004247 001000
000011
51700
DAD
8
3558
004250
001000
080176
51720
MOV
A,M
, [H,L]=ADDRESS TO GO TO
3559 004251 001000
000043
51740
INX
H
3560 004252' 001000
000146
51760
MOV
H,M
3561
004253' 001000
000157
51780
MOV
L.A
3562 004254 001000
000001
51800
LXI
PUTVAL
;RETURN TO PUTVAL
3563 004255' 000000
004261
3564
004256 000000
004242
3565 004257 001000
000305
51820
PUSH
B
3566
004260 001000
000351
51840
PCHL
;DISPATCH TO FORCE
3567
004261 001000
000341
51860
PUTVAL: POP
H
IGET THE POINTER OF WHERE TO STORE
3568
51880
;THE VALUE
3569
004262° 001000
000345
51900
PUSH
H
;SAVE IT BACK
3570 004263 001000
000315
51920
CALL
VMOVMF>
;MOVE THE VALUE IN
3571
004264 000000 000000*
3572
004265 000000
004255'
3573
51940
IFN
LENGTH-2, <
3574
51960
PUSH
H
ISAVE THE VARIABLE POINTER FOR "FOR"
3575
51980
CALL
MOVMF>
;TRANSFER THE VALUE
3576
004266 001000 000321
52000
POP
D
I"FOR" WANTS VARIABLE POINTER IN
3577
52020
110,E) FOR FNDFOR
3578
004267 001000 060341
52040
POP
H
;GET THE TEXT POINTER
3579
004270 001000 000311
52060
RET
3580
52080
PAGE
BASIC MCS 8080 GATES/ALLEN/DAVIDOF
MACRO 47(113) 03:12 10-SEP-75 PAGE 15
F3
MAC
6-SEP-64 03:11
ON GOTO CODE
3581
52100 SUBTTL ON GOTO CODE
3582
52120
IFN
LENGTH,
3583
3584
004271 001000
000315
52160
ONGOTO: CALL
GETBYT
;GET VALUE INTO (E)
3585
004272
000000
011020
3586
004273
000000
004264
3587
004274
001000
000176
52180
MOV
A,M
IGET THE TERMINATOR BACK
3588 004275 001000
000107
52200
MOV
B,A
;SAVE THIS CHARACTER FOR LATER
3589 004276 001000
000376
52220
CPI
GOSUTK
IAN "ON GOSUB" PERHAPS?
3590 004277* 000000
000214
3591 004300 001000
000312
52240
JZ
ISGOSU
EYES, SOME FEATURE USE
3592 004301 000000
004306
3593 004302' 000000
064272
3594 004303 001000
000317
52260
SYNCHK
GOTOTK
!OTHERWISE MUST BE "GOTO"
3595 004304 000000
000210
3596 004305' 001000
000053
52280
DCX
H
BACK UP CHARACTER POINTER
3597 004306 001000
000113
52300
ISGOSU: MOV
C,E
IGET COUNT INTO (c)
3598 004307 001000
000015
52320
LOOPON: DCR
C
;SEE IF ENOUGH SKIPS
3599
004310 001000
000170
52340
MOV
A,B
IPUT DISPATCH CHARACTER IN PLACE
3600
004311 001000
000312
52360
JZ
GONE2
;IF DONE, GO OFF
3601
004312' 000000
003376
3602
0043137 000000
004301
3603
004314 001000
000315
52380
CALL
LINGT2
ISKIP OVER A LINE
#
3604
004315 000000
003643
3605
004316 000000
004312'
3606
004317 001000
000376
52400
CPI
44
iA COMMA
3607
004320' 000000
000054
3608
004321 001000
000306
52420
RNZ
;IF A COMMA DOESN'T DELIMIT THE END OF
3609
52440
,THE LAST LINE # MUST BE THE END OF THE LINE
3610
004322'
001000
000303
52460
JMP
LOOPON>
;CONTINUE GOBBLING LINE #S
3611
004325
000000
004307
3612
004324
000000
004315'
3613
3614
52500
PAGE
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47(113) 03:12 10-SEP-75 PAGE 16
F3
MAC
6-SEP-64 03:11
IF
THEN CODE
3615
52520
SUBTTL IF
...
THEN CODE
3616 004325 001000 000315
52540
IF:
CALL
FRMEVL
EVALUATE A FORMULA
3617
004326' 000000 005336
3618
004327 000000 004323'
3619
52560
IFE
LENGTH,
3620
52580
IFN
STRING,<
3621
52600
LDA
VALTYP
;GET VALUE TYPE INTO [A]
3622
52620
PUSH
PSW>>
;SAVE THE VALUE TYPE ON THE STACK
3623
004330 001000 000176
52640
MOV
A,M
IGET TERMINATING CHARACTER OF FORMULA
3624
52660
IFE
LENGTH,
<
3625
52680
CALL
PUSHF
,ONTO THE STACK
3626
52700
MVI
0,0
SKEEPS RELATIONAL OPERATOR MEMORIES
3627
52720
ILESS THAN =4
3628
52740
EQUAL =2
3629
52760
IGREATER THAN #1
3630
52780
LOOPIF: SUI
GREATK
;CHECK FOR A RELATIONAL OPERATOR
3631
52800
JC
ENDREL
;NOPE
3632
52820
NUMREL=LESSTK-GREATK+1
;NUMBER OF RELATIONAL OPERATORS
3633
52840
CPI
NUMREL
HIS THIS ONE OF THEM?
3634
52860
JNC
ENDREL
INO SEE WHAT WE HAVE
3635
52880
CPI
1
ISETUP BITS BY MAPPING
3636
52900
RAL
10 TO 1, 1 TO 2 AND 2 TO 4
3637
52920
ORA
D
FOR WITH EARLIER BITS
3638
52940
MOV
D,A
;STORE NEW BITS
3639
52960
CHRGET
;GET NEW CHARACTER
3640
52980
JMP
LOOPIF
ISEE IF RELATIONAL
3641
53000
ENDREL: MOV
A,O
;GET REALTIONAL MEMORIES
3642
53020
ORA
A
ISEE IF THERE ARE ANY
3643
53040
JZ
SNERR
;NO RELATIONAL OPERATORS:
3644
53060
PUSH
PSW
;SAVE RELATIONAL MEMORIES
3645
53080
CALL
FRMEVL>
;PICK UP FIRST NON-RELATIONAL
3646
53100
;CHARACTER AGAIN AND INTERPRET FORMULA
3647
53120
IANSWER LEFT IN FAC
3648
004331
001000
000376
53140
IFE
LENGTH-2,<CPI
44
IA COMMA?
3649
004332 000000
000054
3650
004333
001000
000314
53160
CZ
CHRGTR>
;IF so SKIP IT
3651
004334
000000
003426
3652
004335'
000000
004326
3653
53180
IFN
LENGTH, <
3654
004336 001000
000376
53200
CPI
GOTOTK
ALLOW "GOTO" AS WELL
3655
004337 000000
000210
3656
004340 001000
000312
53220
JZ
OKGOTO>
3657
004341 000000
004346
3658
004342' 000000
004334
3659
004343 001000
000317
53240
SYNCHK
THENTK
;MUST HAVE A THEN
3660
004344 000000
000245
3661
004345
001000
060053
53260
DCX
H
3662
004346
53280
OKGOTO:
3663
53300
IFE
LENGTH,
3664
53320
POP
PSW
3665
53340
POPR
;POP OFF NUMBER
3666
53360
IFN
STRING
3667
53380
XTHL>
;COMPARE FORMULA TYPES
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47 (113) 03:12 10-SEP-75 PAGE 16-1
F3
MAC
6-SEP-64 03:11
IF
THEN CODE
3668
53400
IFE
STRING, <PUSH
H>
;SAVE THE TEXT POINTER
3669
53420
PUSH
PSW
RESAVE RELATIONAL MEMORIES
3670
53440
IFN
STRING,
3671
53460
LDA
VALTYP
,GET VALUE TYPE
3672
53480
CMP
H
(H) HAS OLD VALTYP ARE THEY =?
-
3673
53500
JNZ
TMERR
IF NOT ITS A TYPE ERROR
3674
53520
ORA
A
ISEE WHAT TYPE IT WAS
3675
53540
JZ
NUMCMP
IZERO MEANS IT WAS NUMERIC
3676
53560
CALL
STRCMP
MUST BE STRING,SO STRING COMPARE
3677
53580
JMP
SKPNCM>
ISKIP OVER NUMERIC COMPARE
3678
53600
NUMCMP: CALL
FCOMP
;COMPARE THE 2 SIDE OF THE RELATION STATEMENT
3679
53620
SKPNCM: INR
A
;BUILD RELATIONAL BITS
3680
53640
RAL
;LESS=4 EQUAL=2 GREATER=1
3681
53660
;SINCE CARRY IS ON ONLY IN
3682
53680
1377 CASE (FCOMP & STRCMP)
3683
53700
POP
8
;POP OFF WHAT RELATIONAL OPERATOR WAS
3684
53720
ANA
B>
;SEE IF WE MATCHED
3685
53740
IFN
LENGTH,
<
3686
53742
IFE
LENGTH-2,
3687
004346 001000 000315
53744
CALL
VSIGN##>
-
3688
004347 000000 000000*
3689
004350 000000 004341
3690
53746
IFN
LENGTH-2,
3691
53760
FSIGN>>
10=FALSE ALL OTHERS=TRUE
3692
53780
IFE
LENGTH,<
3693
53800
POP
H>
;POP OFF TEXT POINTER
3694
53820
IFE
LENGTH-2,<
3695 004351 001000 000312
53840
JZ
FALSIF>
THANDLE POSSIBLE "ELSE"
3696
004352'
000000
004363
3697
004353
000000
004347
3698
53860
IFN
LENGTH-2,
3699
53880
JZ
REM>
IIF TEST FAILED -- JUST SKIP REST OF THE LINE
3700
004354 001000
000327
53900
DOCOND: CHRGET
;PICK UP THE FIRST LINE # CHARACTER
3701
004355 001000
000332
53920
JC
GOTO
ILINE NUMBER MEANS "GOTO"
3702
004356 000000
004010
3703
004357 000000
004352'
3704
004360° 001000
000303
53940
JMP
GONE3
INTERPRET NEW STATEMENT
3705
004361 000000
003375
-
3706
004362' 000000
004356°
3707
53960
IFE
LENGTH-2,
3708
53980
,
3709
54000
:
"ELSE" HANDLER. HERE ON FALSE "IF" CONDITION
3710
54020
;
3711
004363 001000 000026
54040
FALSIF: MVI
D,1
;NUMBER OF "ELSE"S THAT MUST
-
3712
004364° 000000 000001
3713
54060
;BE SEEN. "DATA" INCREMENTS THIS
3714
54080
;COUNT EVERY TIME AN "IF" IS SEEN
3715
004365 001000 000315
54100
SKPMRF: CALL
DATA
;SKIP A STATEMENT
3716
004366' 000000 004072'
3717
004367' 000000 004361
3718
54120
"":" IS STUCK IN FRONT OF "ELSE"S
3719
54140
180 THAT "DATA" WILL STOP BEFORE "ELSE" CLAUSES
3720
BASIC MCS 8080 GATES/ALLEN/DAVIDOFF
MACRO 47 (113) 03:12 10-SEP-75 PAGE 16-2
F3
MAC
6-SEP-64 03:11
IF
THEN CODE
3721
004370 001000
000267
54160
ORA
A
IEND OF LINE?
3722
004371 001000
060310
54180
RZ
IIF so, NO "ELSE" CLAUSE
3723
004372 001000
060327
54200
CHRGET
ISEE IF WE HIT AN "ELSE"
3724 004373 001000
000376
54220
CPI
ELSETK
3725
0043747 000000
000220
3726
004375' 001000
000302
54240
JNZ
SKPMRF
INO, STILL IN THE "THEN" CLAUSE
3727 004376 000000
004365'
3728 004377 000000
004366
3729
004400 001000
000025
54260
DCR
0
;DECREMENT THE NUMBER OF "ELSE"S THAT
3730
54280
;MUST BE SEEN
3731
004401 001000
000302
54300
JNZ
SKPMRF
;SKIP MORE IF HAVEN'T SEEN
3732 004402' 000000
004365'
3733
004403 000000
004376
3734
54320
TENOUGH
3735 004404 001000 000303
54340
JMP
DOCOND>
;FOUND THE RIGHT "ELSE" -- GO EXECUTE
3736 004405 000000 004354
3737
004406* 000000 004402'
3738
3739
54380
PAGE
-
-
-